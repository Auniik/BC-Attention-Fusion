Dataset Statistics:
--------------------------------------------------------------------------------
Category                                 Images     Patients
--------------------------------------------------------------------------------
benign_adenosis_100X                     113        4
benign_adenosis_200X                     111        4
benign_adenosis_400X                     106        4
benign_adenosis_40X                      114        4
benign_fibroadenoma_100X                 260        10
benign_fibroadenoma_200X                 264        10
benign_fibroadenoma_400X                 237        10
benign_fibroadenoma_40X                  253        10
benign_phyllodes_tumor_100X              121        3
benign_phyllodes_tumor_200X              108        3
benign_phyllodes_tumor_400X              115        3
benign_phyllodes_tumor_40X               109        3
benign_tubular_adenoma_100X              150        7
benign_tubular_adenoma_200X              140        7
benign_tubular_adenoma_400X              130        7
benign_tubular_adenoma_40X               149        7
malignant_ductal_carcinoma_100X          903        38
malignant_ductal_carcinoma_200X          896        38
malignant_ductal_carcinoma_400X          788        38
malignant_ductal_carcinoma_40X           864        38
malignant_lobular_carcinoma_100X         170        5
malignant_lobular_carcinoma_200X         163        5
malignant_lobular_carcinoma_400X         137        5
malignant_lobular_carcinoma_40X          156        5
malignant_mucinous_carcinoma_100X        222        9
malignant_mucinous_carcinoma_200X        196        9
malignant_mucinous_carcinoma_400X        169        9
malignant_mucinous_carcinoma_40X         205        9
malignant_papillary_carcinoma_100X       142        6
malignant_papillary_carcinoma_200X       135        6
malignant_papillary_carcinoma_400X       138        6
malignant_papillary_carcinoma_40X        145        6

Folds.csv Info:
Shape: (197725, 4)

Columns: ['fold', 'mag', 'grp', 'filename']

First few rows:
   fold  mag    grp                                           filename
0     1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
1     1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
2     1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
3     1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
4     1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...

Fold distribution:
fold
1    39545
2    39545
3    39545
4    39545
5    39545
Name: count, dtype: int64

Magnification distribution:
mag
100    52025
200    50325
40     49875
400    45500
Name: count, dtype: int64

Train/Test distribution:
grp
train    158180
test      39545
Name: count, dtype: int64
        fold  mag    grp                                           filename
0          1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
1          1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
2          1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
3          1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
4          1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
...      ...  ...    ...                                                ...
197720     5  400  train  BreaKHis_v1/histology_slides/breast/malignant/...
197721     5  400  train  BreaKHis_v1/histology_slides/breast/malignant/...
197722     5  400  train  BreaKHis_v1/histology_slides/breast/malignant/...
197723     5  400  train  BreaKHis_v1/histology_slides/breast/malignant/...
197724     5  400  train  BreaKHis_v1/histology_slides/breast/malignant/...

[197725 rows x 4 columns]
Dataset structure analysis:
Unique patients: 82

Tumor types distribution:
tumor_class  tumor_type
benign       adenosis               11100
             fibroadenoma           25350
             phyllodes_tumor        11325
             tubular_adenoma        14225
malignant    ductal_carcinoma       86275
             lobular_carcinoma      15650
             mucinous_carcinoma     19800
             papillary_carcinoma    14000
dtype: int64

Patients by number of magnifications available:
magnification
4    82
Name: count, dtype: int64

Images per patient-magnification (sample):
patient_id          magnification
SOB_B_A_14-22549AB  40               725
                    100              750
                    200              800
                    400              750
SOB_B_A_14-22549CD  40               875
                    100              900
                    200              775
                    400              750
SOB_B_A_14-22549G   40               875
                    100              850
                    200              800
                    400              725
SOB_B_A_14-29960CD  40               375
                    100              325
                    200              400
                    400              425
SOB_B_F_14-14134    40               900
                    100              775
                    200              950
                    400              925
dtype: int64

============================================================
FOLD 1 ANALYSIS
============================================================
=== CLASS DISTRIBUTION ANALYSIS ===

Class distribution by split:
tumor_class  benign  malignant
grp
test           3400       5260
train          9000      21885

Class ratio (benign:malignant) in train: 9000:21885

=== TUMOR TYPE DISTRIBUTION ===
tumor_class  tumor_type
benign       adenosis                1570
             fibroadenoma            3495
             phyllodes_tumor         1090
             tubular_adenoma         2845
malignant    ductal_carcinoma       14375
             lobular_carcinoma       1990
             mucinous_carcinoma      3045
             papillary_carcinoma     2475
dtype: int64

=== PATIENT-LEVEL ANALYSIS ===
Unique patients - Benign: 24, Malignant: 58

Images per patient stats:
Mean: 475.2, Std: 179.0

=== MAGNIFICATION BALANCE ===
mag           40    100   200   400
tumor_class
benign       2290  2295  2275  2140
malignant    5580  5750  5630  4925

=== CALCULATED WEIGHTS ===
Class weights: {'malignant': 0.705620287868403, 'benign': 1.7158333333333333}

Tumor type weights (top 5):
  phyllodes_tumor: 3.542
  adenosis: 2.459
  lobular_carcinoma: 1.940
  papillary_carcinoma: 1.560
  tubular_adenoma: 1.357
🔧 Environment detected: runpod
🎯 Device: cuda
🚀 CUDA available with 1 GPU(s)
⚡ Tensor core optimization enabled for NVIDIA RTX 2000 Ada Generation
📊 Batch size: 16 | Workers: 8
model.safetensors: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 36.8M/36.8M [00:00<00:00, 70.4MB/s]
==== 5-FOLD ROTATION STRATEGY ====
🔄 Each fold will be used as train/val, with others as test
📊 This gives 5 independent test results for better generalizability
✅ Zero patient overlap between train/val and test sets

================================================================================
🔄 ROTATION 1/5: Train/Val on Fold 1, Test on Folds [2, 3, 4, 5]
================================================================================
🔍 Mode 'test' filtering:
   Total available patients: 82
   Patients with test samples: 17
   Filtered patients for test: 17
🔍 Mode 'test' filtering:
   Total available patients: 82
   Patients with test samples: 16
   Filtered patients for test: 16
🔍 Mode 'test' filtering:
   Total available patients: 82
   Patients with test samples: 16
   Filtered patients for test: 16
🔍 Mode 'test' filtering:
   Total available patients: 82
   Patients with test samples: 16
   Filtered patients for test: 16
📊 Train/Val fold 1: 82 total patients
📊 Test patients: 65 from folds [2, 3, 4, 5]
📊 Test samples: 30885
==== Training on Fold 1 ====
🔍 Mode 'train' filtering:
   Total available patients: 82
   Patients with train samples: 65
   Filtered patients for train: 65
   ✅ No patient overlap between train and test
Balanced dataset: 736 benign, 736 malignant
Dataset initialized:
  Mode: train
  Patients: 65
  Samples per epoch: 1472
  Magnifications: [40, 100, 200, 400]
🔍 Mode 'test' filtering:
   Total available patients: 82
   Patients with test samples: 17
   Filtered patients for test: 17
Dataset initialized:
  Mode: test
  Patients: 17
  Samples per epoch: 204
  Magnifications: [40, 100, 200, 400]
📈 Using batch size: 16 | Workers: 8 | Environment: runpod
Starting training...
Starting 25 epoch training with warmup for 3 epochs
Early stopping patience: 8 epochs

Epoch 1/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 92/92 [01:12<00:00,  1.27it/s, loss=0.5983]
Validating: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 13/13 [00:38<00:00,  2.95s/it]
Train - Loss: 0.6684, Acc: 0.5082, F1: 0.5063, Bal_Acc: 0.5082
Val - Loss: 0.8809, Acc: 0.5147, F1: 0.5220, Bal_Acc: 0.4326
Per-class Acc: (B: 0.2333, M: 0.6319)
Tumor Acc: 0.2843, LR: 0.00e+00
No improvement - Per-class requirement not met (min: 0.2333 < 0.85)

Epoch 2/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 92/92 [00:35<00:00,  2.56it/s, loss=0.2719]
Validating: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 13/13 [00:03<00:00,  4.20it/s]
Train - Loss: 0.3997, Acc: 0.8213, F1: 0.8212, Bal_Acc: 0.8213
Val - Loss: 0.6557, Acc: 0.8922, F1: 0.8927, Bal_Acc: 0.8750
Per-class Acc: (B: 0.8333, M: 0.9167)
Tumor Acc: 0.5637, LR: 1.67e-04
No improvement - Per-class requirement not met (min: 0.8333 < 0.85)

Epoch 3/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 92/92 [00:36<00:00,  2.54it/s, loss=0.2493]
Validating: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 13/13 [00:03<00:00,  4.28it/s]
Train - Loss: 0.2139, Acc: 0.9490, F1: 0.9490, Bal_Acc: 0.9490
Val - Loss: 0.5807, Acc: 0.8971, F1: 0.8963, Bal_Acc: 0.8688
Per-class Acc: (B: 0.8000, M: 0.9375)
Tumor Acc: 0.6275, LR: 3.33e-04
No improvement - Per-class requirement not met (min: 0.8000 < 0.85)

Epoch 4/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 92/92 [00:36<00:00,  2.53it/s, loss=0.1847]
Validating: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 13/13 [00:03<00:00,  4.22it/s]
Train - Loss: 0.1857, Acc: 0.9504, F1: 0.9504, Bal_Acc: 0.9504
Val - Loss: 0.7027, Acc: 0.8235, F1: 0.8064, Bal_Acc: 0.7243
Per-class Acc: (B: 0.4833, M: 0.9653)
Tumor Acc: 0.5588, LR: 5.00e-04
No improvement - Per-class requirement not met (min: 0.4833 < 0.85)

Epoch 5/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 92/92 [00:36<00:00,  2.49it/s, loss=0.1444]
Validating: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 13/13 [00:03<00:00,  4.26it/s]
Train - Loss: 0.1478, Acc: 0.9701, F1: 0.9701, Bal_Acc: 0.9701
Val - Loss: 0.4955, Acc: 0.8824, F1: 0.8811, Bal_Acc: 0.8486
Per-class Acc: (B: 0.7667, M: 0.9306)
Tumor Acc: 0.6618, LR: 4.97e-04
No improvement - Per-class requirement not met (min: 0.7667 < 0.85)

Epoch 6/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 92/92 [00:37<00:00,  2.46it/s, loss=0.1037]
Validating: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 13/13 [00:03<00:00,  4.28it/s]
Train - Loss: 0.1151, Acc: 0.9796, F1: 0.9796, Bal_Acc: 0.9796
Val - Loss: 0.5115, Acc: 0.8873, F1: 0.8901, Bal_Acc: 0.8958
Per-class Acc: (B: 0.9167, M: 0.8750)
Tumor Acc: 0.6618, LR: 4.90e-04
🎯 New best accuracy: 0.8873 (Bal: 0.8958) - Model saved!
   Per-class performance: B=0.9167, M=0.8750 ✅

Epoch 7/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 92/92 [00:37<00:00,  2.48it/s, loss=0.1550]
Validating: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 13/13 [00:03<00:00,  4.14it/s]
Train - Loss: 0.1212, Acc: 0.9701, F1: 0.9701, Bal_Acc: 0.9701
Val - Loss: 0.5407, Acc: 0.8873, F1: 0.8901, Bal_Acc: 0.8958
Per-class Acc: (B: 0.9167, M: 0.8750)
Tumor Acc: 0.7108, LR: 4.77e-04
No improvement for 1/8 epochs

Epoch 8/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 92/92 [00:37<00:00,  2.48it/s, loss=0.1171]
Validating: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 13/13 [00:03<00:00,  4.16it/s]
Train - Loss: 0.0944, Acc: 0.9830, F1: 0.9830, Bal_Acc: 0.9830
Val - Loss: 0.5225, Acc: 0.8824, F1: 0.8805, Bal_Acc: 0.8438
Per-class Acc: (B: 0.7500, M: 0.9375)
Tumor Acc: 0.7157, LR: 4.60e-04
No improvement - Per-class requirement not met (min: 0.7500 < 0.85)

Epoch 9/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 92/92 [00:37<00:00,  2.48it/s, loss=0.1112]
Validating: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 13/13 [00:03<00:00,  4.13it/s]
Train - Loss: 0.1016, Acc: 0.9803, F1: 0.9803, Bal_Acc: 0.9803
Val - Loss: 0.5574, Acc: 0.8971, F1: 0.8906, Bal_Acc: 0.8299
Per-class Acc: (B: 0.6667, M: 0.9931)
Tumor Acc: 0.5931, LR: 4.39e-04
No improvement - Per-class requirement not met (min: 0.6667 < 0.85)

Epoch 10/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 92/92 [00:36<00:00,  2.50it/s, loss=0.0829]
Validating: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 13/13 [00:03<00:00,  4.24it/s]
Train - Loss: 0.1079, Acc: 0.9755, F1: 0.9755, Bal_Acc: 0.9755
Val - Loss: 0.7163, Acc: 0.7990, F1: 0.7995, Bal_Acc: 0.7604
Per-class Acc: (B: 0.6667, M: 0.8542)
Tumor Acc: 0.5637, LR: 4.14e-04
No improvement - Per-class requirement not met (min: 0.6667 < 0.85)

Epoch 11/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 92/92 [00:37<00:00,  2.46it/s, loss=0.0602]
Validating: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 13/13 [00:03<00:00,  4.11it/s]
Train - Loss: 0.0789, Acc: 0.9891, F1: 0.9891, Bal_Acc: 0.9891
Val - Loss: 0.6678, Acc: 0.8775, F1: 0.8717, Bal_Acc: 0.8160
Per-class Acc: (B: 0.6667, M: 0.9653)
Tumor Acc: 0.6618, LR: 3.85e-04
No improvement - Per-class requirement not met (min: 0.6667 < 0.85)

Epoch 12/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 92/92 [00:36<00:00,  2.50it/s, loss=0.0563]
Validating: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 13/13 [00:02<00:00,  4.34it/s]
Train - Loss: 0.0911, Acc: 0.9823, F1: 0.9823, Bal_Acc: 0.9823
Val - Loss: 0.6371, Acc: 0.8873, F1: 0.8828, Bal_Acc: 0.8326
Per-class Acc: (B: 0.7000, M: 0.9653)
Tumor Acc: 0.5098, LR: 3.54e-04
No improvement - Per-class requirement not met (min: 0.7000 < 0.85)

Epoch 13/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 92/92 [00:36<00:00,  2.50it/s, loss=0.0523]
Validating: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 13/13 [00:02<00:00,  4.46it/s]
Train - Loss: 0.0968, Acc: 0.9844, F1: 0.9844, Bal_Acc: 0.9844
Val - Loss: 0.6726, Acc: 0.8775, F1: 0.8717, Bal_Acc: 0.8160
Per-class Acc: (B: 0.6667, M: 0.9653)
Tumor Acc: 0.5294, LR: 3.20e-04
No improvement - Per-class requirement not met (min: 0.6667 < 0.85)

Epoch 14/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 92/92 [00:37<00:00,  2.46it/s, loss=0.0781]
Validating: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 13/13 [00:03<00:00,  4.30it/s]
Train - Loss: 0.0760, Acc: 0.9857, F1: 0.9857, Bal_Acc: 0.9857
Val - Loss: 0.7238, Acc: 0.8578, F1: 0.8533, Bal_Acc: 0.8021
Per-class Acc: (B: 0.6667, M: 0.9375)
Tumor Acc: 0.6520, LR: 2.86e-04
No improvement - Per-class requirement not met (min: 0.6667 < 0.85)

⏹️ Early stopping triggered after 14 epochs
Best standard accuracy: 0.8873
Best balanced accuracy: 0.8958

📊 Loading best checkpoint for final evaluation...
/workspace/BC-Attention-Fusion/main.py:234: FutureWarning: You are using `torch.load` with `weights_only=False` (the current default value), which uses the default pickle module implicitly. It is possible to construct malicious pickle data which will execute arbitrary code during unpickling (See https://github.com/pytorch/pytorch/blob/main/SECURITY.md#untrusted-models for more details). In a future release, the default value for `weights_only` will be flipped to `True`. This limits the functions that could be executed during unpickling. Arbitrary objects will no longer be allowed to be loaded via this mode unless they are explicitly allowlisted by the user via `torch.serialization.add_safe_globals`. We recommend you start setting `weights_only=True` for any use case where you don't have full control of the loaded file. Please open an issue on GitHub for any issues related to this experimental feature.
  checkpoint = torch.load(f'output/best_model_fold_{fold}.pth', map_location=device)
🔍 Re-evaluating with best checkpoint...

=== DETAILED CLASSIFICATION REPORT ===
              precision    recall  f1-score   support

      benign     0.7534    0.9167    0.8271        60
   malignant     0.9618    0.8750    0.9164       144

    accuracy                         0.8873       204
   macro avg     0.8576    0.8958    0.8717       204
weighted avg     0.9005    0.8873    0.8901       204


=== CONFUSION MATRIX ===
Predicted:  benign  malignant
benign:         55        5
malignant:      18      126

=== KEY INSIGHTS ===
Benign Recall: 0.9167 (55/60)
Malignant Recall: 0.8750 (126/144)

Prediction distribution: benign=73, malignant=131
Analyzing cross-magnification feature importance...

Final Validation Accuracy: 0.8873

Magnification Importance Analysis:
40x contribution: 0.0184 ± 0.0826
100x contribution: 0.0029 ± 0.0766
200x contribution: -0.0141 ± 0.1169
400x contribution: 0.0397 ± 0.0743

================================================================================
🧪 FINAL TEST EVALUATION ON FOLDS [2, 3, 4, 5]
================================================================================
Dataset initialized:
  Mode: test
  Patients: 65
  Samples per epoch: 780
  Magnifications: [40, 100, 200, 400]
📊 Test Set: 65 patients, 780 samples
🔬 FINAL TEST RESULTS:

=== DETAILED CLASSIFICATION REPORT ===
              precision    recall  f1-score   support

      benign     0.9785    1.0000    0.9892       228
   malignant     1.0000    0.9909    0.9955       552

    accuracy                         0.9936       780
   macro avg     0.9893    0.9955    0.9923       780
weighted avg     0.9937    0.9936    0.9936       780


=== CONFUSION MATRIX ===
Predicted:  benign  malignant
benign:        228        0
malignant:       5      547

=== KEY INSIGHTS ===
Benign Recall: 1.0000 (228/228)
Malignant Recall: 0.9909 (547/552)

Prediction distribution: benign=233, malignant=547

🎯 ROTATION 1 RESULTS:
   Test Accuracy: 0.9936
   Test F1 Score: 0.9955
   Test Balanced Acc: 0.9955
================================================================================

================================================================================
🏆 FINAL SUMMARY: 5-FOLD ROTATION RESULTS
================================================================================

📊 VALIDATION RESULTS (across 5 rotations):
   Mean: 0.8873 ± 0.0000
   Range: 0.8873 - 0.8873

🧪 TEST RESULTS (across 5 rotations):
   Mean Accuracy: 0.9936 ± 0.0000
   Mean F1: 0.9955 ± 0.0000
   Range: 0.9936 - 0.9936

📋 DETAILED ROTATION RESULTS:
   Rotation 1: Val=0.8873, Test=0.9936

✅ Realistic test accuracy range - no perfect scores detected

🎯 FINAL ASSESSMENT:
   🎉 EXCELLENT: Mean test accuracy 99.4%
================================================================================

================================================================================
🔄 ROTATION 2/5: Train/Val on Fold 2, Test on Folds [1, 3, 4, 5]
================================================================================
🔍 Mode 'test' filtering:
   Total available patients: 82
   Patients with test samples: 17
   Filtered patients for test: 17
🔍 Mode 'test' filtering:
   Total available patients: 82
   Patients with test samples: 16
   Filtered patients for test: 16
🔍 Mode 'test' filtering:
   Total available patients: 82
   Patients with test samples: 16
   Filtered patients for test: 16
🔍 Mode 'test' filtering:
   Total available patients: 82
   Patients with test samples: 16
   Filtered patients for test: 16
📊 Train/Val fold 2: 82 total patients
📊 Test patients: 65 from folds [1, 3, 4, 5]
📊 Test samples: 32420
==== Training on Fold 2 ====
🔍 Mode 'train' filtering:
   Total available patients: 82
   Patients with train samples: 65
   Filtered patients for train: 65
   ✅ No patient overlap between train and test
Balanced dataset: 736 benign, 736 malignant
Dataset initialized:
  Mode: train
  Patients: 65
  Samples per epoch: 1472
  Magnifications: [40, 100, 200, 400]
🔍 Mode 'test' filtering:
   Total available patients: 82
   Patients with test samples: 17
   Filtered patients for test: 17
Dataset initialized:
  Mode: test
  Patients: 17
  Samples per epoch: 204
  Magnifications: [40, 100, 200, 400]
📈 Using batch size: 16 | Workers: 8 | Environment: runpod
Starting training...
Starting 25 epoch training with warmup for 3 epochs
Early stopping patience: 8 epochs

Epoch 1/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 92/92 [01:13<00:00,  1.26it/s, loss=0.1268]
Validating: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 13/13 [00:37<00:00,  2.91s/it]
Train - Loss: 0.2564, Acc: 0.9260, F1: 0.9260, Bal_Acc: 0.9260
Val - Loss: 0.2706, Acc: 1.0000, F1: 1.0000, Bal_Acc: 1.0000
Per-class Acc: (B: 1.0000, M: 1.0000)
Tumor Acc: 0.9118, LR: 0.00e+00
🎯 New best accuracy: 1.0000 (Bal: 1.0000) - Model saved!
   Per-class performance: B=1.0000, M=1.0000 ✅

Epoch 2/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 92/92 [00:37<00:00,  2.48it/s, loss=0.1114]
Validating: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 13/13 [00:03<00:00,  4.17it/s]
Train - Loss: 0.1603, Acc: 0.9599, F1: 0.9599, Bal_Acc: 0.9599
Val - Loss: 0.3011, Acc: 0.9755, F1: 0.9752, Bal_Acc: 0.9583
Per-class Acc: (B: 0.9167, M: 1.0000)
Tumor Acc: 0.7157, LR: 1.67e-04
No improvement for 1/8 epochs

Epoch 3/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 92/92 [00:37<00:00,  2.48it/s, loss=0.1951]
Validating: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 13/13 [00:03<00:00,  4.20it/s]
Train - Loss: 0.1800, Acc: 0.9416, F1: 0.9416, Bal_Acc: 0.9416
Val - Loss: 0.3424, Acc: 0.9755, F1: 0.9752, Bal_Acc: 0.9583
Per-class Acc: (B: 0.9167, M: 1.0000)
Tumor Acc: 0.7157, LR: 3.33e-04
No improvement for 2/8 epochs

Epoch 4/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 92/92 [00:37<00:00,  2.46it/s, loss=0.1254]
Validating: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 13/13 [00:03<00:00,  4.17it/s]
Train - Loss: 0.1877, Acc: 0.9457, F1: 0.9456, Bal_Acc: 0.9457
Val - Loss: 0.3242, Acc: 1.0000, F1: 1.0000, Bal_Acc: 1.0000
Per-class Acc: (B: 1.0000, M: 1.0000)
Tumor Acc: 0.6912, LR: 5.00e-04
No improvement for 3/8 epochs

Epoch 5/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 92/92 [00:36<00:00,  2.49it/s, loss=0.2217]
Validating: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 13/13 [00:03<00:00,  4.15it/s]
Train - Loss: 0.2083, Acc: 0.9273, F1: 0.9273, Bal_Acc: 0.9273
Val - Loss: 0.3530, Acc: 1.0000, F1: 1.0000, Bal_Acc: 1.0000
Per-class Acc: (B: 1.0000, M: 1.0000)
Tumor Acc: 0.6324, LR: 4.97e-04
No improvement for 4/8 epochs

Epoch 6/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 92/92 [00:37<00:00,  2.47it/s, loss=0.3498]
Validating: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 13/13 [00:03<00:00,  4.06it/s]
Train - Loss: 0.2223, Acc: 0.9266, F1: 0.9266, Bal_Acc: 0.9266
Val - Loss: 0.3857, Acc: 1.0000, F1: 1.0000, Bal_Acc: 1.0000
Per-class Acc: (B: 1.0000, M: 1.0000)
Tumor Acc: 0.6569, LR: 4.90e-04
No improvement for 5/8 epochs

Epoch 7/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 92/92 [00:37<00:00,  2.47it/s, loss=0.1384]
Validating: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 13/13 [00:03<00:00,  4.25it/s]
Train - Loss: 0.1846, Acc: 0.9409, F1: 0.9409, Bal_Acc: 0.9409
Val - Loss: 0.4817, Acc: 0.9755, F1: 0.9752, Bal_Acc: 0.9583
Per-class Acc: (B: 0.9167, M: 1.0000)
Tumor Acc: 0.5882, LR: 4.77e-04
No improvement for 6/8 epochs

Epoch 8/25
--------------------------------------------------
Training:  16%|████████████████████▋                                                                                                          | 15/92 [00:08<00:31,  2.46it/s, loss=0.1061]^Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 92/92 [00:37<00:00,  2.47it/s, loss=0.1052]
Validating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 13/13 [00:03<00:00,  4.04it/s]
Train - Loss: 0.1244, Acc: 0.9735, F1: 0.9735, Bal_Acc: 0.9735
Val - Loss: 0.3276, Acc: 0.9902, F1: 0.9902, Bal_Acc: 0.9931
Per-class Acc: (B: 1.0000, M: 0.9861)
Tumor Acc: 0.7353, LR: 4.60e-04
No improvement for 7/8 epochs

Epoch 9/25
--------------------------------------------------
Training: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 92/92 [00:37<00:00,  2.47it/s, loss=0.0914]
Validating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 13/13 [00:03<00:00,  4.13it/s]
Train - Loss: 0.1348, Acc: 0.9749, F1: 0.9749, Bal_Acc: 0.9749
Val - Loss: 0.4147, Acc: 0.9902, F1: 0.9902, Bal_Acc: 0.9931
Per-class Acc: (B: 1.0000, M: 0.9861)
Tumor Acc: 0.5784, LR: 4.39e-04
No improvement for 8/8 epochs

⏹️ Early stopping triggered after 9 epochs
Best standard accuracy: 1.0000
Best balanced accuracy: 1.0000

📊 Loading best checkpoint for final evaluation...
/workspace/BC-Attention-Fusion/main.py:234: FutureWarning: You are using `torch.load` with `weights_only=False` (the current default value), which uses the default pickle module implicitly. It is possible to construct malicious pickle data which will execute arbitrary code during unpickling (See https://github.com/pytorch/pytorch/blob/main/SECURITY.md#untrusted-models for more details). In a future release, the default value for `weights_only` will be flipped to `True`. This limits the functions that could be executed during unpickling. Arbitrary objects will no longer be allowed to be loaded via this mode unless they are explicitly allowlisted by the user via `torch.serialization.add_safe_globals`. We recommend you start setting `weights_only=True` for any use case where you don't have full control of the loaded file. Please open an issue on GitHub for any issues related to this experimental feature.
  checkpoint = torch.load(f'output/best_model_fold_{fold}.pth', map_location=device)
🔍 Re-evaluating with best checkpoint...

=== DETAILED CLASSIFICATION REPORT ===
              precision    recall  f1-score   support

      benign     1.0000    1.0000    1.0000        60
   malignant     1.0000    1.0000    1.0000       144

    accuracy                         1.0000       204
   macro avg     1.0000    1.0000    1.0000       204
weighted avg     1.0000    1.0000    1.0000       204


=== CONFUSION MATRIX ===
Predicted:  benign  malignant
benign:         60        0
malignant:       0      144

=== KEY INSIGHTS ===
Benign Recall: 1.0000 (60/60)
Malignant Recall: 1.0000 (144/144)

Prediction distribution: benign=60, malignant=144
Analyzing cross-magnification feature importance...

Final Validation Accuracy: 1.0000

Magnification Importance Analysis:
40x contribution: 0.0395 ± 0.0585
100x contribution: 0.0302 ± 0.0733
200x contribution: 0.0169 ± 0.1204
400x contribution: 0.0175 ± 0.0610

================================================================================
🧪 FINAL TEST EVALUATION ON FOLDS [1, 3, 4, 5]
================================================================================
Dataset initialized:
  Mode: test
  Patients: 65
  Samples per epoch: 780
  Magnifications: [40, 100, 200, 400]
📊 Test Set: 65 patients, 780 samples
🔬 FINAL TEST RESULTS:

=== DETAILED CLASSIFICATION REPORT ===
              precision    recall  f1-score   support

      benign     0.9356    0.9561    0.9458       228
   malignant     0.9817    0.9728    0.9773       552

    accuracy                         0.9679       780
   macro avg     0.9587    0.9645    0.9615       780
weighted avg     0.9682    0.9679    0.9680       780


=== CONFUSION MATRIX ===
Predicted:  benign  malignant
benign:        218       10
malignant:      15      537

=== KEY INSIGHTS ===
Benign Recall: 0.9561 (218/228)
Malignant Recall: 0.9728 (537/552)

Prediction distribution: benign=233, malignant=547

🎯 ROTATION 2 RESULTS:
   Test Accuracy: 0.9679
   Test F1 Score: 0.9773
   Test Balanced Acc: 0.9645
================================================================================

================================================================================
🏆 FINAL SUMMARY: 5-FOLD ROTATION RESULTS
================================================================================

📊 VALIDATION RESULTS (across 5 rotations):
   Mean: 0.9436 ± 0.0564
   Range: 0.8873 - 1.0000

🧪 TEST RESULTS (across 5 rotations):
   Mean Accuracy: 0.9808 ± 0.0128
   Mean F1: 0.9864 ± 0.0091
   Range: 0.9679 - 0.9936

📋 DETAILED ROTATION RESULTS:
   Rotation 1: Val=0.8873, Test=0.9936
   Rotation 2: Val=1.0000, Test=0.9679

✅ Realistic test accuracy range - no perfect scores detected

🎯 FINAL ASSESSMENT:
   🎉 EXCELLENT: Mean test accuracy 98.1%
================================================================================

================================================================================
🔄 ROTATION 3/5: Train/Val on Fold 3, Test on Folds [1, 2, 4, 5]
================================================================================
🔍 Mode 'test' filtering:
   Total available patients: 82
   Patients with test samples: 17
   Filtered patients for test: 17
🔍 Mode 'test' filtering:
   Total available patients: 82
   Patients with test samples: 17
   Filtered patients for test: 17
🔍 Mode 'test' filtering:
   Total available patients: 82
   Patients with test samples: 16
   Filtered patients for test: 16
🔍 Mode 'test' filtering:
   Total available patients: 82
   Patients with test samples: 16
   Filtered patients for test: 16
📊 Train/Val fold 3: 82 total patients
📊 Test patients: 66 from folds [1, 2, 4, 5]
📊 Test samples: 30735
==== Training on Fold 3 ====
🔍 Mode 'train' filtering:
   Total available patients: 82
   Patients with train samples: 66
   Filtered patients for train: 66
   ✅ No patient overlap between train and test
Balanced dataset: 752 benign, 752 malignant
Dataset initialized:
  Mode: train
  Patients: 66
  Samples per epoch: 1504
  Magnifications: [40, 100, 200, 400]
🔍 Mode 'test' filtering:
   Total available patients: 82
   Patients with test samples: 16
   Filtered patients for test: 16
Dataset initialized:
  Mode: test
  Patients: 16
  Samples per epoch: 192
  Magnifications: [40, 100, 200, 400]
📈 Using batch size: 16 | Workers: 8 | Environment: runpod
Starting training...
Starting 25 epoch training with warmup for 3 epochs
Early stopping patience: 8 epochs

Epoch 1/25
--------------------------------------------------
Training: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 94/94 [01:14<00:00,  1.27it/s, loss=0.1200]
Validating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 12/12 [00:38<00:00,  3.17s/it]
Train - Loss: 0.2489, Acc: 0.9262, F1: 0.9262, Bal_Acc: 0.9262
Val - Loss: 0.2954, Acc: 1.0000, F1: 1.0000, Bal_Acc: 1.0000
Per-class Acc: (B: 1.0000, M: 1.0000)
Tumor Acc: 0.6615, LR: 0.00e+00
🎯 New best accuracy: 1.0000 (Bal: 1.0000) - Model saved!
   Per-class performance: B=1.0000, M=1.0000 ✅

Epoch 2/25
--------------------------------------------------
Training: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 94/94 [00:38<00:00,  2.47it/s, loss=0.0833]
Validating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 12/12 [00:03<00:00,  3.89it/s]
Train - Loss: 0.1523, Acc: 0.9614, F1: 0.9614, Bal_Acc: 0.9614
Val - Loss: 0.3459, Acc: 0.9688, F1: 0.9683, Bal_Acc: 0.9500
Per-class Acc: (B: 0.9000, M: 1.0000)
Tumor Acc: 0.6667, LR: 1.67e-04
No improvement for 1/8 epochs

Epoch 3/25
--------------------------------------------------
Training: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 94/94 [00:38<00:00,  2.46it/s, loss=0.1229]
Validating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 12/12 [00:03<00:00,  3.89it/s]
Train - Loss: 0.1401, Acc: 0.9628, F1: 0.9628, Bal_Acc: 0.9628
Val - Loss: 0.3828, Acc: 0.9375, F1: 0.9354, Bal_Acc: 0.9000
Per-class Acc: (B: 0.8000, M: 1.0000)
Tumor Acc: 0.5469, LR: 3.33e-04
No improvement - Per-class requirement not met (min: 0.8000 < 0.85)

Epoch 4/25
--------------------------------------------------
Training: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 94/94 [00:38<00:00,  2.47it/s, loss=0.0919]
Validating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 12/12 [00:03<00:00,  3.75it/s]
Train - Loss: 0.1646, Acc: 0.9568, F1: 0.9568, Bal_Acc: 0.9568
Val - Loss: 0.5802, Acc: 0.8542, F1: 0.8447, Bal_Acc: 0.7848
Per-class Acc: (B: 0.6000, M: 0.9697)
Tumor Acc: 0.6094, LR: 5.00e-04
No improvement - Per-class requirement not met (min: 0.6000 < 0.85)

Epoch 5/25
--------------------------------------------------
Training: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 94/94 [00:38<00:00,  2.47it/s, loss=0.1205]
Validating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 12/12 [00:03<00:00,  3.90it/s]
Train - Loss: 0.1470, Acc: 0.9668, F1: 0.9668, Bal_Acc: 0.9668
Val - Loss: 0.5461, Acc: 0.9271, F1: 0.9241, Bal_Acc: 0.8833
Per-class Acc: (B: 0.7667, M: 1.0000)
Tumor Acc: 0.5990, LR: 4.97e-04
No improvement - Per-class requirement not met (min: 0.7667 < 0.85)

Epoch 6/25
--------------------------------------------------
Training: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 94/94 [00:38<00:00,  2.46it/s, loss=0.1185]
Validating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 12/12 [00:03<00:00,  3.88it/s]
Train - Loss: 0.1668, Acc: 0.9574, F1: 0.9574, Bal_Acc: 0.9574
Val - Loss: 0.5343, Acc: 0.8958, F1: 0.8936, Bal_Acc: 0.8606
Per-class Acc: (B: 0.7667, M: 0.9545)
Tumor Acc: 0.4896, LR: 4.90e-04
No improvement - Per-class requirement not met (min: 0.7667 < 0.85)

Epoch 7/25
--------------------------------------------------
Training: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 94/94 [00:37<00:00,  2.48it/s, loss=0.0942]
Validating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 12/12 [00:03<00:00,  3.99it/s]
Train - Loss: 0.1465, Acc: 0.9608, F1: 0.9608, Bal_Acc: 0.9608
Val - Loss: 0.6328, Acc: 0.8229, F1: 0.8045, Bal_Acc: 0.7303
Per-class Acc: (B: 0.4833, M: 0.9773)
Tumor Acc: 0.5208, LR: 4.77e-04
No improvement - Per-class requirement not met (min: 0.4833 < 0.85)

Epoch 8/25
--------------------------------------------------
Training: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 94/94 [00:38<00:00,  2.47it/s, loss=0.1399]
Validating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 12/12 [00:03<00:00,  3.95it/s]
Train - Loss: 0.1632, Acc: 0.9561, F1: 0.9561, Bal_Acc: 0.9561
Val - Loss: 1.0289, Acc: 0.8490, F1: 0.8324, Bal_Acc: 0.7583
Per-class Acc: (B: 0.5167, M: 1.0000)
Tumor Acc: 0.4583, LR: 4.60e-04
No improvement - Per-class requirement not met (min: 0.5167 < 0.85)

Epoch 9/25
--------------------------------------------------
Training: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 94/94 [00:37<00:00,  2.48it/s, loss=0.0689]
Validating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 12/12 [00:02<00:00,  4.02it/s]
Train - Loss: 0.1326, Acc: 0.9741, F1: 0.9741, Bal_Acc: 0.9741
Val - Loss: 0.6294, Acc: 0.8698, F1: 0.8720, Bal_Acc: 0.8689
Per-class Acc: (B: 0.8667, M: 0.8712)
Tumor Acc: 0.4792, LR: 4.39e-04
No improvement for 8/8 epochs

⏹️ Early stopping triggered after 9 epochs
Best standard accuracy: 1.0000
Best balanced accuracy: 1.0000

📊 Loading best checkpoint for final evaluation...
/workspace/BC-Attention-Fusion/main.py:234: FutureWarning: You are using `torch.load` with `weights_only=False` (the current default value), which uses the default pickle module implicitly. It is possible to construct malicious pickle data which will execute arbitrary code during unpickling (See https://github.com/pytorch/pytorch/blob/main/SECURITY.md#untrusted-models for more details). In a future release, the default value for `weights_only` will be flipped to `True`. This limits the functions that could be executed during unpickling. Arbitrary objects will no longer be allowed to be loaded via this mode unless they are explicitly allowlisted by the user via `torch.serialization.add_safe_globals`. We recommend you start setting `weights_only=True` for any use case where you don't have full control of the loaded file. Please open an issue on GitHub for any issues related to this experimental feature.
  checkpoint = torch.load(f'output/best_model_fold_{fold}.pth', map_location=device)
🔍 Re-evaluating with best checkpoint...

=== DETAILED CLASSIFICATION REPORT ===
              precision    recall  f1-score   support

      benign     1.0000    1.0000    1.0000        60
   malignant     1.0000    1.0000    1.0000       132

    accuracy                         1.0000       192
   macro avg     1.0000    1.0000    1.0000       192
weighted avg     1.0000    1.0000    1.0000       192


=== CONFUSION MATRIX ===
Predicted:  benign  malignant
benign:         60        0
malignant:       0      132

=== KEY INSIGHTS ===
Benign Recall: 1.0000 (60/60)
Malignant Recall: 1.0000 (132/132)

Prediction distribution: benign=60, malignant=132
Analyzing cross-magnification feature importance...

Final Validation Accuracy: 1.0000

Magnification Importance Analysis:
40x contribution: 0.0256 ± 0.0965
100x contribution: 0.0244 ± 0.0678
200x contribution: 0.0395 ± 0.0689
400x contribution: 0.0232 ± 0.0337

================================================================================
🧪 FINAL TEST EVALUATION ON FOLDS [1, 2, 4, 5]
================================================================================
Dataset initialized:
  Mode: test
  Patients: 66
  Samples per epoch: 792
  Magnifications: [40, 100, 200, 400]
📊 Test Set: 66 patients, 792 samples
🔬 FINAL TEST RESULTS:

=== DETAILED CLASSIFICATION REPORT ===
              precision    recall  f1-score   support

      benign     0.8831    0.9605    0.9202       228
   malignant     0.9835    0.9486    0.9657       564

    accuracy                         0.9520       792
   macro avg     0.9333    0.9546    0.9429       792
weighted avg     0.9546    0.9520    0.9526       792


=== CONFUSION MATRIX ===
Predicted:  benign  malignant
benign:        219        9
malignant:      29      535

=== KEY INSIGHTS ===
Benign Recall: 0.9605 (219/228)
Malignant Recall: 0.9486 (535/564)

Prediction distribution: benign=248, malignant=544

🎯 ROTATION 3 RESULTS:
   Test Accuracy: 0.9520
   Test F1 Score: 0.9657
   Test Balanced Acc: 0.9546
================================================================================

================================================================================
🏆 FINAL SUMMARY: 5-FOLD ROTATION RESULTS
================================================================================

📊 VALIDATION RESULTS (across 5 rotations):
   Mean: 0.9624 ± 0.0531
   Range: 0.8873 - 1.0000

🧪 TEST RESULTS (across 5 rotations):
   Mean Accuracy: 0.9712 ± 0.0171
   Mean F1: 0.9795 ± 0.0122
   Range: 0.9520 - 0.9936

📋 DETAILED ROTATION RESULTS:
   Rotation 1: Val=0.8873, Test=0.9936
   Rotation 2: Val=1.0000, Test=0.9679
   Rotation 3: Val=1.0000, Test=0.9520

✅ Realistic test accuracy range - no perfect scores detected

🎯 FINAL ASSESSMENT:
   🎉 EXCELLENT: Mean test accuracy 97.1%
================================================================================

================================================================================
🔄 ROTATION 4/5: Train/Val on Fold 4, Test on Folds [1, 2, 3, 5]
================================================================================
🔍 Mode 'test' filtering:
   Total available patients: 82
   Patients with test samples: 17
   Filtered patients for test: 17
🔍 Mode 'test' filtering:
   Total available patients: 82
   Patients with test samples: 17
   Filtered patients for test: 17
🔍 Mode 'test' filtering:
   Total available patients: 82
   Patients with test samples: 16
   Filtered patients for test: 16
🔍 Mode 'test' filtering:
   Total available patients: 82
   Patients with test samples: 16
   Filtered patients for test: 16
📊 Train/Val fold 4: 82 total patients
📊 Test patients: 66 from folds [1, 2, 3, 5]
📊 Test samples: 31600
==== Training on Fold 4 ====
🔍 Mode 'train' filtering:
   Total available patients: 82
   Patients with train samples: 66
   Filtered patients for train: 66
   ✅ No patient overlap between train and test
Balanced dataset: 752 benign, 752 malignant
Dataset initialized:
  Mode: train
  Patients: 66
  Samples per epoch: 1504
  Magnifications: [40, 100, 200, 400]
🔍 Mode 'test' filtering:
   Total available patients: 82
   Patients with test samples: 16
   Filtered patients for test: 16
Dataset initialized:
  Mode: test
  Patients: 16
  Samples per epoch: 192
  Magnifications: [40, 100, 200, 400]
📈 Using batch size: 16 | Workers: 8 | Environment: runpod
Starting training...
Starting 25 epoch training with warmup for 3 epochs
Early stopping patience: 8 epochs

Epoch 1/25
--------------------------------------------------
Training: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 94/94 [01:14<00:00,  1.26it/s, loss=0.5081]
Validating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 12/12 [00:38<00:00,  3.20s/it]
Train - Loss: 0.2649, Acc: 0.9242, F1: 0.9242, Bal_Acc: 0.9242
Val - Loss: 0.2240, Acc: 1.0000, F1: 1.0000, Bal_Acc: 1.0000
Per-class Acc: (B: 1.0000, M: 1.0000)
Tumor Acc: 0.9323, LR: 0.00e+00
🎯 New best accuracy: 1.0000 (Bal: 1.0000) - Model saved!
   Per-class performance: B=1.0000, M=1.0000 ✅

Epoch 2/25
--------------------------------------------------
Training: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 94/94 [00:37<00:00,  2.48it/s, loss=0.0945]
Validating: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 12/12 [00:03<00:00,  3.87it/s]
Train - Loss: 0.1533, Acc: 0.9555, F1: 0.9555, Bal_Acc: 0.9555
Val - Loss: 0.2903, Acc: 0.9896, F1: 0.9895, Bal_Acc: 0.9833
Per-class Acc: (B: 0.9667, M: 1.0000)
Tumor Acc: 0.8125, LR: 1.67e-04
No improvement for 1/8 epochs

Epoch 3/25