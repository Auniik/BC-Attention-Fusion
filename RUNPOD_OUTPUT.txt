root@e70b373009f7:/workspace/BC-Attention-Fusion#   python main_robust_holdout.py
üéØ ROBUST HOLDOUT ANTI-OVERFITTING EVALUATION
====================================================================================================
üö® Testing multiple configurations to address 100% test accuracy issue
üí° Expected: More realistic performance across all configurations
====================================================================================================

====================================================================================================
üéØ TESTING ROBUST CONFIGURATION: BALANCED_LARGE_TEST
====================================================================================================
üñ•Ô∏è  Device: cuda
üîß Number of workers: 8
üìÇ Loaded robust holdout split (balanced_large_test): 197725 image samples
   Train: 119000 images
   Validation: 34250 images
   Test: 44475 images
Dataset Statistics:
--------------------------------------------------------------------------------
Category                                 Images     Patients
--------------------------------------------------------------------------------
benign_adenosis_100X                     113        4
benign_adenosis_200X                     111        4
benign_adenosis_400X                     106        4
benign_adenosis_40X                      114        4
benign_fibroadenoma_100X                 260        10
benign_fibroadenoma_200X                 264        10
benign_fibroadenoma_400X                 237        10
benign_fibroadenoma_40X                  253        10
benign_phyllodes_tumor_100X              121        3
benign_phyllodes_tumor_200X              108        3
benign_phyllodes_tumor_400X              115        3
benign_phyllodes_tumor_40X               109        3
benign_tubular_adenoma_100X              150        7
benign_tubular_adenoma_200X              140        7
benign_tubular_adenoma_400X              130        7
benign_tubular_adenoma_40X               149        7
malignant_ductal_carcinoma_100X          903        38
malignant_ductal_carcinoma_200X          896        38
malignant_ductal_carcinoma_400X          788        38
malignant_ductal_carcinoma_40X           864        38
malignant_lobular_carcinoma_100X         170        5
malignant_lobular_carcinoma_200X         163        5
malignant_lobular_carcinoma_400X         137        5
malignant_lobular_carcinoma_40X          156        5
malignant_mucinous_carcinoma_100X        222        9
malignant_mucinous_carcinoma_200X        196        9
malignant_mucinous_carcinoma_400X        169        9
malignant_mucinous_carcinoma_40X         205        9
malignant_papillary_carcinoma_100X       142        6
malignant_papillary_carcinoma_200X       135        6
malignant_papillary_carcinoma_400X       138        6
malignant_papillary_carcinoma_40X        145        6

Folds.csv Info:
Shape: (197725, 4)

Columns: ['fold', 'mag', 'grp', 'filename']

First few rows:
   fold  mag    grp                                           filename
0     1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
1     1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
2     1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
3     1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
4     1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...

Fold distribution:
fold
1    39545
2    39545
3    39545
4    39545
5    39545
Name: count, dtype: int64

Magnification distribution:
mag
100    52025
200    50325
40     49875
400    45500
Name: count, dtype: int64

Train/Test distribution:
grp
train    158180
test      39545
Name: count, dtype: int64
        fold  mag    grp                                           filename
0          1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
1          1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
2          1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
3          1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
4          1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
...      ...  ...    ...                                                ...
197720     5  400  train  BreaKHis_v1/histology_slides/breast/malignant/...
197721     5  400  train  BreaKHis_v1/histology_slides/breast/malignant/...
197722     5  400  train  BreaKHis_v1/histology_slides/breast/malignant/...
197723     5  400  train  BreaKHis_v1/histology_slides/breast/malignant/...
197724     5  400  train  BreaKHis_v1/histology_slides/breast/malignant/...

[197725 rows x 4 columns]
Dataset structure analysis:
Unique patients: 82

Tumor types distribution:
tumor_class  tumor_type
benign       adenosis               11100
             fibroadenoma           25350
             phyllodes_tumor        11325
             tubular_adenoma        14225
malignant    ductal_carcinoma       86275
             lobular_carcinoma      15650
             mucinous_carcinoma     19800
             papillary_carcinoma    14000
dtype: int64

Patients by number of magnifications available:
magnification
4    82
Name: count, dtype: int64

Images per patient-magnification (sample):
patient_id          magnification
SOB_B_A_14-22549AB  40               725
                    100              750
                    200              800
                    400              750
SOB_B_A_14-22549CD  40               875
                    100              900
                    200              775
                    400              750
SOB_B_A_14-22549G   40               875
                    100              850
                    200              800
                    400              725
SOB_B_A_14-29960CD  40               375
                    100              325
                    200              400
                    400              425
SOB_B_F_14-14134    40               900
                    100              775
                    200              950
                    400              925
dtype: int64

============================================================
FOLD 1 ANALYSIS
============================================================
=== CLASS DISTRIBUTION ANALYSIS ===

Class distribution by split:
tumor_class  benign  malignant
grp
test           3400       5260
train          9000      21885

Class ratio (benign:malignant) in train: 9000:21885

=== TUMOR TYPE DISTRIBUTION ===
tumor_class  tumor_type
benign       adenosis                1570
             fibroadenoma            3495
             phyllodes_tumor         1090
             tubular_adenoma         2845
malignant    ductal_carcinoma       14375
             lobular_carcinoma       1990
             mucinous_carcinoma      3045
             papillary_carcinoma     2475
dtype: int64

=== PATIENT-LEVEL ANALYSIS ===
Unique patients - Benign: 24, Malignant: 58

Images per patient stats:
Mean: 475.2, Std: 179.0

=== MAGNIFICATION BALANCE ===
mag           40    100   200   400
tumor_class
benign       2290  2295  2275  2140
malignant    5580  5750  5630  4925

=== CALCULATED WEIGHTS ===
Class weights: {'malignant': 0.705620287868403, 'benign': 1.7158333333333333}

Tumor type weights (top 5):
  phyllodes_tumor: 3.542
  adenosis: 2.459
  lobular_carcinoma: 1.940
  papillary_carcinoma: 1.560
  tubular_adenoma: 1.357

üìà Dataset Statistics:
   Total patients with all magnifications: 82
   Training samples: 119000
   Test samples: 44475
üîç Mode 'train' filtering:
   Total available patients: 82
   Patients with train samples: 50
   Filtered patients for train: 50
   ‚úÖ No patient overlap between train and test
üîç Mode 'val' filtering:
   Total available patients: 82
   Patients with val samples: 15
   Filtered patients for val: 15
üîç Mode 'test' filtering:
   Total available patients: 82
   Patients with test samples: 17
   Filtered patients for test: 17

üéØ Patient Splits:
   Train: 50 patients
   Validation: 15 patients
   Test: 17 patients

üèóÔ∏è  Creating datasets...
Balanced dataset: 560 benign, 560 malignant
Dataset initialized:
  Mode: train
  Patients: 50
  Samples per epoch: 1120
  Magnifications: [40, 100, 200, 400]
Dataset initialized:
  Mode: val
  Patients: 15
  Samples per epoch: 180
  Magnifications: [40, 100, 200, 400]
Dataset initialized:
  Mode: test
  Patients: 17
  Samples per epoch: 204
  Magnifications: [40, 100, 200, 400]

üìä Dataset Sizes:
   Train: 1120 samples
   Validation: 180 samples
   Test: 204 samples

üöÄ Starting training...
   Model: LightweightMultiMagNet
   Epochs: 25
   Learning rate: 0.0005
   Batch size: 8
model.safetensors: 100%|--------‚ñà‚ñà| 36.8M/36.8M [00:00<00:00, 137MB/s]
Starting 25 epoch training with warmup for 3 epochs
Early stopping patience: 8 epochs

Epoch 1/25
--------------------------------------------------
Training: 100%|--------| 140/140 [00:26<00:00,  5.26it/s, loss=0.5163]
Validating: 100%|----------------| 23/23 [00:02<00:00,  9.06it/s]
Train - Loss: 0.6640, Acc: 0.4955, F1: 0.4926, Bal_Acc: 0.4955
Val - Loss: 0.9529, Acc: 0.3500, F1: 0.3869, Bal_Acc: 0.3182
Per-class Acc: (B: 0.2500, M: 0.3864)
Tumor Acc: 0.0833, LR: 0.00e+00
No improvement - Per-class requirement not met (min: 0.2500 < 0.85)

Epoch 2/25
--------------------------------------------------
Training: 100%|--------| 140/140 [00:25<00:00,  5.60it/s, loss=0.3773]
Validating: 100%|----------------| 23/23 [00:02<00:00,  9.28it/s]
Train - Loss: 0.4224, Acc: 0.7866, F1: 0.7864, Bal_Acc: 0.7866
Val - Loss: 0.7172, Acc: 0.8000, F1: 0.7901, Bal_Acc: 0.7045
Per-class Acc: (B: 0.5000, M: 0.9091)
Tumor Acc: 0.6000, LR: 1.67e-04
No improvement - Per-class requirement not met (min: 0.5000 < 0.85)

Epoch 3/25
--------------------------------------------------
Training: 100%|--------| 140/140 [00:24<00:00,  5.68it/s, loss=0.1851]
Validating: 100%|----------------| 23/23 [00:02<00:00,  9.50it/s]
Train - Loss: 0.3033, Acc: 0.8875, F1: 0.8875, Bal_Acc: 0.8875
Val - Loss: 0.6835, Acc: 0.8667, F1: 0.8667, Bal_Acc: 0.8295
Per-class Acc: (B: 0.7500, M: 0.9091)
Tumor Acc: 0.6000, LR: 3.33e-04
No improvement - Per-class requirement not met (min: 0.7500 < 0.85)

Epoch 4/25
--------------------------------------------------
Training: 100%|--------| 140/140 [00:24<00:00,  5.70it/s, loss=0.2434]
Validating: 100%|----------------| 23/23 [00:02<00:00,  9.25it/s]
Train - Loss: 0.2375, Acc: 0.9179, F1: 0.9179, Bal_Acc: 0.9179
Val - Loss: 0.6998, Acc: 0.8667, F1: 0.8667, Bal_Acc: 0.8295
Per-class Acc: (B: 0.7500, M: 0.9091)
Tumor Acc: 0.6667, LR: 5.00e-04
No improvement - Per-class requirement not met (min: 0.7500 < 0.85)

Epoch 5/25
--------------------------------------------------
Training: 100%|--------| 140/140 [00:25<00:00,  5.54it/s, loss=0.1957]
Validating: 100%|----------------| 23/23 [00:02<00:00,  9.09it/s]
Train - Loss: 0.2374, Acc: 0.9205, F1: 0.9205, Bal_Acc: 0.9205
Val - Loss: 0.5529, Acc: 0.8667, F1: 0.8500, Bal_Acc: 0.7500
Per-class Acc: (B: 0.5000, M: 1.0000)
Tumor Acc: 0.6000, LR: 4.97e-04
No improvement - Per-class requirement not met (min: 0.5000 < 0.85)

Epoch 6/25
--------------------------------------------------
Training: 100%|--------| 140/140 [00:24<00:00,  5.71it/s, loss=0.1059]
Validating: 100%|----------------| 23/23 [00:02<00:00,  9.28it/s]
Train - Loss: 0.1957, Acc: 0.9402, F1: 0.9402, Bal_Acc: 0.9402
Val - Loss: 0.5128, Acc: 0.9333, F1: 0.9300, Bal_Acc: 0.8750
Per-class Acc: (B: 0.7500, M: 1.0000)
Tumor Acc: 0.6000, LR: 4.90e-04
No improvement - Per-class requirement not met (min: 0.7500 < 0.85)

Epoch 7/25
--------------------------------------------------
Training: 100%|--------| 140/140 [00:24<00:00,  5.68it/s, loss=0.1071]
Validating: 100%|----------------| 23/23 [00:02<00:00,  9.22it/s]
Train - Loss: 0.2188, Acc: 0.9446, F1: 0.9446, Bal_Acc: 0.9446
Val - Loss: 0.5611, Acc: 0.9333, F1: 0.9300, Bal_Acc: 0.8750
Per-class Acc: (B: 0.7500, M: 1.0000)
Tumor Acc: 0.6667, LR: 4.77e-04
No improvement - Per-class requirement not met (min: 0.7500 < 0.85)

Epoch 8/25
--------------------------------------------------
Training: 100%|--------| 140/140 [00:24<00:00,  5.61it/s, loss=0.2190]
Validating: 100%|----------------| 23/23 [00:02<00:00,  9.07it/s]
Train - Loss: 0.1946, Acc: 0.9402, F1: 0.9402, Bal_Acc: 0.9402
Val - Loss: 0.6947, Acc: 0.8000, F1: 0.7520, Bal_Acc: 0.6250
Per-class Acc: (B: 0.2500, M: 1.0000)
Tumor Acc: 0.4944, LR: 4.60e-04
No improvement - Per-class requirement not met (min: 0.2500 < 0.85)

‚èπÔ∏è Early stopping triggered after 8 epochs
Best standard accuracy: 0.0000
Best balanced accuracy: 0.0000

================================================================================
üìä VALIDATION EVALUATION
================================================================================
üìà Validation Results:
   Accuracy: 0.8000
   Balanced Accuracy: 0.6250
   Precision: 0.7857
   Recall: 1.0000
   F1-Score: 0.8800

üîç PREDICTION CONFIDENCE ANALYSIS - VALIDATION
============================================================
üìä Confidence Statistics:
   Mean confidence: 0.7791
   Median confidence: 0.7300
   Min confidence: 0.6355
   Max confidence: 0.9624

üö® Overconfidence Detection:
   Predictions with >95% confidence: 29/180 (16.1%)
   Predictions with >99% confidence: 0/180 (0.0%)
   ‚úÖ Confidence levels appear reasonable

üìà Confidence-Accuracy Correlation:
   Accuracy on high-confidence predictions: 1.0000
   Accuracy on lower-confidence predictions: 0.7616
   ‚ö†Ô∏è  Poor calibration - confidence doesn't match accuracy

================================================================================
üß™ FINAL TEST EVALUATION
================================================================================
üö® These patients were NEVER seen during training or validation
üéØ FINAL TEST RESULTS:
   Accuracy: 0.8235
   Balanced Accuracy: 0.7000
   Precision: 0.8000
   Recall: 1.0000
   F1-Score: 0.8889

üîç Final Test Confusion Matrix:
   [[TN=24, FP=36],
    [FN=0, TP=144]]

üîç PREDICTION CONFIDENCE ANALYSIS - TEST
============================================================
üìä Confidence Statistics:
   Mean confidence: 0.7363
   Median confidence: 0.7569
   Min confidence: 0.5139
   Max confidence: 0.8859

üö® Overconfidence Detection:
   Predictions with >95% confidence: 0/204 (0.0%)
   Predictions with >99% confidence: 0/204 (0.0%)
   ‚úÖ Confidence levels appear reasonable

üìà Confidence-Accuracy Correlation:
   Accuracy on high-confidence predictions: 0.0000
   Accuracy on lower-confidence predictions: 0.8235
   ‚ö†Ô∏è  Poor calibration - confidence doesn't match accuracy

üìã Final Test Classification Report:
              precision    recall  f1-score   support

      Benign       1.00      0.40      0.57        60
   Malignant       0.80      1.00      0.89       144

    accuracy                           0.82       204
   macro avg       0.90      0.70      0.73       204
weighted avg       0.86      0.82      0.80       204


====================================================================================================
üéØ TESTING ROBUST CONFIGURATION: MODERATE_TEST
====================================================================================================
üñ•Ô∏è  Device: cuda
üîß Number of workers: 8
üìÇ Loaded robust holdout split (moderate_test): 197725 image samples
   Train: 130025 images
   Validation: 30650 images
   Test: 37050 images

üìà Dataset Statistics:
   Total patients with all magnifications: 82
   Training samples: 130025
   Test samples: 37050
üîç Mode 'train' filtering:
   Total available patients: 82
   Patients with train samples: 55
   Filtered patients for train: 55
   ‚úÖ No patient overlap between train and test
üîç Mode 'val' filtering:
   Total available patients: 82
   Patients with val samples: 12
   Filtered patients for val: 12
üîç Mode 'test' filtering:
   Total available patients: 82
   Patients with test samples: 15
   Filtered patients for test: 15

üéØ Patient Splits:
   Train: 55 patients
   Validation: 12 patients
   Test: 15 patients

üèóÔ∏è  Creating datasets...
Balanced dataset: 624 benign, 624 malignant
Dataset initialized:
  Mode: train
  Patients: 55
  Samples per epoch: 1248
  Magnifications: [40, 100, 200, 400]
Dataset initialized:
  Mode: val
  Patients: 12
  Samples per epoch: 144
  Magnifications: [40, 100, 200, 400]
Dataset initialized:
  Mode: test
  Patients: 15
  Samples per epoch: 180
  Magnifications: [40, 100, 200, 400]

üìä Dataset Sizes:
   Train: 1248 samples
   Validation: 144 samples
   Test: 180 samples

üöÄ Starting training...
   Model: LightweightMultiMagNet
   Epochs: 25
   Learning rate: 0.0005
   Batch size: 8
Starting 25 epoch training with warmup for 3 epochs
Early stopping patience: 8 epochs

Epoch 1/25
--------------------------------------------------
Training: 100%|--------| 156/156 [00:28<00:00,  5.46it/s, loss=0.6697]
Validating: 100%|----------------| 18/18 [00:02<00:00,  8.18it/s]
Train - Loss: 0.6464, Acc: 0.5064, F1: 0.5015, Bal_Acc: 0.5064
Val - Loss: 0.9298, Acc: 0.4861, F1: 0.4470, Bal_Acc: 0.6042
Per-class Acc: (B: 0.9583, M: 0.2500)
Tumor Acc: 0.0000, LR: 0.00e+00
No improvement - Per-class requirement not met (min: 0.2500 < 0.85)

Epoch 2/25
--------------------------------------------------
Training: 100%|--------| 156/156 [00:28<00:00,  5.56it/s, loss=0.3114]
Validating: 100%|----------------| 18/18 [00:02<00:00,  8.19it/s]
Train - Loss: 0.4071, Acc: 0.8021, F1: 0.8021, Bal_Acc: 0.8021
Val - Loss: 0.6706, Acc: 0.8472, F1: 0.8480, Bal_Acc: 0.8333
Per-class Acc: (B: 0.7917, M: 0.8750)
Tumor Acc: 0.4861, LR: 1.67e-04
No improvement - Per-class requirement not met (min: 0.7917 < 0.85)

Epoch 3/25
--------------------------------------------------
Training: 100%|--------| 156/156 [00:28<00:00,  5.49it/s, loss=0.4318]
Validating: 100%|----------------| 18/18 [00:02<00:00,  7.59it/s]
Train - Loss: 0.3163, Acc: 0.8654, F1: 0.8654, Bal_Acc: 0.8654
Val - Loss: 0.5770, Acc: 0.8333, F1: 0.8333, Bal_Acc: 0.8125
Per-class Acc: (B: 0.7500, M: 0.8750)
Tumor Acc: 0.6806, LR: 3.33e-04
No improvement - Per-class requirement not met (min: 0.7500 < 0.85)

Epoch 4/25
--------------------------------------------------
Training: 100%|--------| 156/156 [00:27<00:00,  5.61it/s, loss=0.1945]
Validating: 100%|----------------| 18/18 [00:02<00:00,  8.26it/s]
Train - Loss: 0.2649, Acc: 0.9103, F1: 0.9103, Bal_Acc: 0.9103
Val - Loss: 0.5034, Acc: 0.9028, F1: 0.8978, Bal_Acc: 0.8542
Per-class Acc: (B: 0.7083, M: 1.0000)
Tumor Acc: 0.7500, LR: 5.00e-04
No improvement - Per-class requirement not met (min: 0.7083 < 0.85)

Epoch 5/25
--------------------------------------------------
Training: 100%|--------| 156/156 [00:28<00:00,  5.50it/s, loss=0.2238]
Validating: 100%|----------------| 18/18 [00:02<00:00,  7.29it/s]
Train - Loss: 0.2900, Acc: 0.8862, F1: 0.8862, Bal_Acc: 0.8862
Val - Loss: 0.5646, Acc: 0.9167, F1: 0.9185, Bal_Acc: 0.9375
Per-class Acc: (B: 1.0000, M: 0.8750)
Tumor Acc: 0.5972, LR: 4.97e-04
üéØ New best accuracy: 0.9167 (Bal: 0.9375) - Model saved!
   Per-class performance: B=1.0000, M=0.8750 ‚úÖ

Epoch 6/25
--------------------------------------------------
Training: 100%|--------| 156/156 [00:29<00:00,  5.30it/s, loss=0.1281]
Validating: 100%|----------------| 18/18 [00:02<00:00,  8.30it/s]
Train - Loss: 0.2350, Acc: 0.9215, F1: 0.9215, Bal_Acc: 0.9215
Val - Loss: 0.5183, Acc: 0.8333, F1: 0.8333, Bal_Acc: 0.8125
Per-class Acc: (B: 0.7500, M: 0.8750)
Tumor Acc: 0.5625, LR: 4.90e-04
No improvement - Per-class requirement not met (min: 0.7500 < 0.85)

Epoch 7/25
--------------------------------------------------
Training: 100%|--------| 156/156 [00:28<00:00,  5.44it/s, loss=0.0814]
Validating: 100%|----------------| 18/18 [00:02<00:00,  8.31it/s]
Train - Loss: 0.1855, Acc: 0.9423, F1: 0.9423, Bal_Acc: 0.9423
Val - Loss: 0.5265, Acc: 0.8333, F1: 0.8333, Bal_Acc: 0.8125
Per-class Acc: (B: 0.7500, M: 0.8750)
Tumor Acc: 0.6111, LR: 4.77e-04
No improvement - Per-class requirement not met (min: 0.7500 < 0.85)

Epoch 8/25
--------------------------------------------------
Training: 100%|--------| 156/156 [00:27<00:00,  5.73it/s, loss=0.1194]
Validating: 100%|----------------| 18/18 [00:02<00:00,  7.98it/s]
Train - Loss: 0.1943, Acc: 0.9391, F1: 0.9391, Bal_Acc: 0.9391
Val - Loss: 0.4703, Acc: 0.8333, F1: 0.8333, Bal_Acc: 0.8125
Per-class Acc: (B: 0.7500, M: 0.8750)
Tumor Acc: 0.6944, LR: 4.60e-04
No improvement - Per-class requirement not met (min: 0.7500 < 0.85)

Epoch 9/25
--------------------------------------------------
Training: 100%|--------| 156/156 [00:27<00:00,  5.69it/s, loss=0.1221]
Validating: 100%|----------------| 18/18 [00:02<00:00,  8.22it/s]
Train - Loss: 0.2060, Acc: 0.9359, F1: 0.9359, Bal_Acc: 0.9359
Val - Loss: 0.6116, Acc: 0.8194, F1: 0.8185, Bal_Acc: 0.7917
Per-class Acc: (B: 0.7083, M: 0.8750)
Tumor Acc: 0.5000, LR: 4.39e-04
No improvement - Per-class requirement not met (min: 0.7083 < 0.85)

Epoch 10/25
--------------------------------------------------
Training: 100%|--------| 156/156 [00:27<00:00,  5.70it/s, loss=0.1171]
Validating: 100%|----------------| 18/18 [00:02<00:00,  8.37it/s]
Train - Loss: 0.1793, Acc: 0.9463, F1: 0.9463, Bal_Acc: 0.9463
Val - Loss: 0.5217, Acc: 0.9167, F1: 0.9185, Bal_Acc: 0.9375
Per-class Acc: (B: 1.0000, M: 0.8750)
Tumor Acc: 0.5833, LR: 4.14e-04
No improvement for 5/8 epochs

Epoch 11/25
--------------------------------------------------
Training: 100%|--------| 156/156 [00:26<00:00,  5.83it/s, loss=0.1049]
Validating: 100%|----------------| 18/18 [00:02<00:00,  8.29it/s]
Train - Loss: 0.1484, Acc: 0.9663, F1: 0.9663, Bal_Acc: 0.9663
Val - Loss: 0.9385, Acc: 0.8333, F1: 0.8148, Bal_Acc: 0.7500
Per-class Acc: (B: 0.5000, M: 1.0000)
Tumor Acc: 0.4722, LR: 3.85e-04
No improvement - Per-class requirement not met (min: 0.5000 < 0.85)

Epoch 12/25
--------------------------------------------------
Training: 100%|--------| 156/156 [00:27<00:00,  5.58it/s, loss=0.1726]
Validating: 100%|----------------| 18/18 [00:02<00:00,  8.31it/s]
Train - Loss: 0.1527, Acc: 0.9615, F1: 0.9615, Bal_Acc: 0.9615
Val - Loss: 0.5472, Acc: 0.7639, F1: 0.7560, Bal_Acc: 0.7083
Per-class Acc: (B: 0.5417, M: 0.8750)
Tumor Acc: 0.6736, LR: 3.54e-04
No improvement - Per-class requirement not met (min: 0.5417 < 0.85)

Epoch 13/25
--------------------------------------------------
Training: 100%|--------| 156/156 [00:27<00:00,  5.61it/s, loss=0.0628]
Validating: 100%|----------------| 18/18 [00:02<00:00,  7.88it/s]
Train - Loss: 0.1601, Acc: 0.9671, F1: 0.9671, Bal_Acc: 0.9671
Val - Loss: 0.5511, Acc: 0.9167, F1: 0.9185, Bal_Acc: 0.9375
Per-class Acc: (B: 1.0000, M: 0.8750)
Tumor Acc: 0.5764, LR: 3.20e-04
No improvement for 8/8 epochs

‚èπÔ∏è Early stopping triggered after 13 epochs
Best standard accuracy: 0.9167
Best balanced accuracy: 0.9375

================================================================================
üìä VALIDATION EVALUATION
================================================================================
üìà Validation Results:
   Accuracy: 0.9167
   Balanced Accuracy: 0.9375
   Precision: 1.0000
   Recall: 0.8750
   F1-Score: 0.9333

üîç PREDICTION CONFIDENCE ANALYSIS - VALIDATION
============================================================
üìä Confidence Statistics:
   Mean confidence: 0.7494
   Median confidence: 0.6881
   Min confidence: 0.5583
   Max confidence: 0.9963

üö® Overconfidence Detection:
   Predictions with >95% confidence: 35/144 (24.3%)
   Predictions with >99% confidence: 3/144 (2.1%)
   ‚úÖ Confidence levels appear reasonable

üìà Confidence-Accuracy Correlation:
   Accuracy on high-confidence predictions: 1.0000
   Accuracy on lower-confidence predictions: 0.8899
   ‚ö†Ô∏è  Poor calibration - confidence doesn't match accuracy

================================================================================
üß™ FINAL TEST EVALUATION
================================================================================
üö® These patients were NEVER seen during training or validation
üéØ FINAL TEST RESULTS:
   Accuracy: 0.9833
   Balanced Accuracy: 0.9688
   Precision: 0.9778
   Recall: 1.0000
   F1-Score: 0.9888

üîç Final Test Confusion Matrix:
   [[TN=45, FP=3],
    [FN=0, TP=132]]

üîç PREDICTION CONFIDENCE ANALYSIS - TEST
============================================================
üìä Confidence Statistics:
   Mean confidence: 0.7688
   Median confidence: 0.7989
   Min confidence: 0.5197
   Max confidence: 0.9960

üö® Overconfidence Detection:
   Predictions with >95% confidence: 24/180 (13.3%)
   Predictions with >99% confidence: 12/180 (6.7%)
   ‚úÖ Confidence levels appear reasonable

üìà Confidence-Accuracy Correlation:
   Accuracy on high-confidence predictions: 1.0000
   Accuracy on lower-confidence predictions: 0.9808
   ‚úÖ Good calibration - confidence matches accuracy

üìã Final Test Classification Report:
              precision    recall  f1-score   support

      Benign       1.00      0.94      0.97        48
   Malignant       0.98      1.00      0.99       132

    accuracy                           0.98       180
   macro avg       0.99      0.97      0.98       180
weighted avg       0.98      0.98      0.98       180


====================================================================================================
üéØ TESTING ROBUST CONFIGURATION: LARGE_TEST
====================================================================================================
üñ•Ô∏è  Device: cuda
üîß Number of workers: 8
üìÇ Loaded robust holdout split (large_test): 197725 image samples
   Train: 107325 images
   Validation: 43175 images
   Test: 47225 images

üìà Dataset Statistics:
   Total patients with all magnifications: 82
   Training samples: 107325
   Test samples: 47225
üîç Mode 'train' filtering:
   Total available patients: 82
   Patients with train samples: 45
   Filtered patients for train: 45
   ‚úÖ No patient overlap between train and test
üîç Mode 'val' filtering:
   Total available patients: 82
   Patients with val samples: 17
   Filtered patients for val: 17
üîç Mode 'test' filtering:
   Total available patients: 82
   Patients with test samples: 20
   Filtered patients for test: 20

üéØ Patient Splits:
   Train: 45 patients
   Validation: 17 patients
   Test: 20 patients

üèóÔ∏è  Creating datasets...
Balanced dataset: 512 benign, 512 malignant
Dataset initialized:
  Mode: train
  Patients: 45
  Samples per epoch: 1024
  Magnifications: [40, 100, 200, 400]
Dataset initialized:
  Mode: val
  Patients: 17
  Samples per epoch: 204
  Magnifications: [40, 100, 200, 400]
Dataset initialized:
  Mode: test
  Patients: 20
  Samples per epoch: 240
  Magnifications: [40, 100, 200, 400]

üìä Dataset Sizes:
   Train: 1024 samples
   Validation: 204 samples
   Test: 240 samples

üöÄ Starting training...
   Model: LightweightMultiMagNet
   Epochs: 25
   Learning rate: 0.0005
   Batch size: 8
Starting 25 epoch training with warmup for 3 epochs
Early stopping patience: 8 epochs

Epoch 1/25
--------------------------------------------------
Training: 100%|--------| 128/128 [00:22<00:00,  5.62it/s, loss=1.4707]
Validating: 100%|----------------| 26/26 [00:02<00:00,  9.27it/s]
Train - Loss: 0.8307, Acc: 0.5107, F1: 0.4292, Bal_Acc: 0.5107
Val - Loss: 0.8838, Acc: 0.7059, F1: 0.5842, Bal_Acc: 0.5000
Per-class Acc: (B: 0.0000, M: 1.0000)
Tumor Acc: 0.0588, LR: 0.00e+00
No improvement - Per-class requirement not met (min: 0.0000 < 0.85)

Epoch 2/25
--------------------------------------------------
Training: 100%|--------| 128/128 [00:22<00:00,  5.64it/s, loss=0.8535]
Validating: 100%|----------------| 26/26 [00:02<00:00,  9.33it/s]
Train - Loss: 0.4731, Acc: 0.7490, F1: 0.7469, Bal_Acc: 0.7490
Val - Loss: 0.9193, Acc: 0.5882, F1: 0.6063, Bal_Acc: 0.5917
Per-class Acc: (B: 0.6000, M: 0.5833)
Tumor Acc: 0.5882, LR: 1.67e-04
No improvement - Per-class requirement not met (min: 0.5833 < 0.85)

Epoch 3/25
--------------------------------------------------
Training: 100%|--------| 128/128 [00:22<00:00,  5.73it/s, loss=0.2875]
Validating: 100%|----------------| 26/26 [00:02<00:00,  9.41it/s]
Train - Loss: 0.3562, Acc: 0.8262, F1: 0.8262, Bal_Acc: 0.8262
Val - Loss: 0.7783, Acc: 0.7647, F1: 0.7647, Bal_Acc: 0.7167
Per-class Acc: (B: 0.6000, M: 0.8333)
Tumor Acc: 0.4461, LR: 3.33e-04
No improvement - Per-class requirement not met (min: 0.6000 < 0.85)

Epoch 4/25
--------------------------------------------------
Training: 100%|--------| 128/128 [00:23<00:00,  5.56it/s, loss=0.1836]
Validating: 100%|----------------| 26/26 [00:02<00:00,  9.35it/s]
Train - Loss: 0.2809, Acc: 0.8984, F1: 0.8984, Bal_Acc: 0.8984
Val - Loss: 0.8401, Acc: 0.6471, F1: 0.6622, Bal_Acc: 0.6917
Per-class Acc: (B: 0.8000, M: 0.5833)
Tumor Acc: 0.4706, LR: 5.00e-04
No improvement - Per-class requirement not met (min: 0.5833 < 0.85)

Epoch 5/25
--------------------------------------------------
Training: 100%|--------| 128/128 [00:22<00:00,  5.73it/s, loss=0.1579]
Validating: 100%|----------------| 26/26 [00:02<00:00,  9.42it/s]
Train - Loss: 0.2283, Acc: 0.9160, F1: 0.9160, Bal_Acc: 0.9160
Val - Loss: 0.8092, Acc: 0.7647, F1: 0.7647, Bal_Acc: 0.7167
Per-class Acc: (B: 0.6000, M: 0.8333)
Tumor Acc: 0.5294, LR: 4.97e-04
No improvement - Per-class requirement not met (min: 0.6000 < 0.85)

Epoch 6/25
--------------------------------------------------
Training: 100%|--------| 128/128 [00:22<00:00,  5.59it/s, loss=0.2236]
Validating: 100%|----------------| 26/26 [00:03<00:00,  8.65it/s]
Train - Loss: 0.2133, Acc: 0.9189, F1: 0.9189, Bal_Acc: 0.9189
Val - Loss: 0.8189, Acc: 0.7059, F1: 0.7129, Bal_Acc: 0.6750
Per-class Acc: (B: 0.6000, M: 0.7500)
Tumor Acc: 0.4412, LR: 4.90e-04
No improvement - Per-class requirement not met (min: 0.6000 < 0.85)

Epoch 7/25
--------------------------------------------------
Training: 100%|--------| 128/128 [00:22<00:00,  5.66it/s, loss=0.1181]
Validating: 100%|----------------| 26/26 [00:02<00:00,  9.16it/s]
Train - Loss: 0.2048, Acc: 0.9326, F1: 0.9326, Bal_Acc: 0.9326
Val - Loss: 0.7908, Acc: 0.8235, F1: 0.8173, Bal_Acc: 0.7583
Per-class Acc: (B: 0.6000, M: 0.9167)
Tumor Acc: 0.3824, LR: 4.77e-04
No improvement - Per-class requirement not met (min: 0.6000 < 0.85)

Epoch 8/25
--------------------------------------------------
Training: 100%|--------| 128/128 [00:22<00:00,  5.70it/s, loss=0.0826]
Validating: 100%|----------------| 26/26 [00:02<00:00,  9.18it/s]
Train - Loss: 0.2144, Acc: 0.9258, F1: 0.9258, Bal_Acc: 0.9258
Val - Loss: 0.9199, Acc: 0.8824, F1: 0.8824, Bal_Acc: 0.8583
Per-class Acc: (B: 0.8000, M: 0.9167)
Tumor Acc: 0.4118, LR: 4.60e-04
No improvement - Per-class requirement not met (min: 0.8000 < 0.85)

‚èπÔ∏è Early stopping triggered after 8 epochs
Best standard accuracy: 0.0000
Best balanced accuracy: 0.0000

================================================================================
üìä VALIDATION EVALUATION
================================================================================
üìà Validation Results:
   Accuracy: 0.8824
   Balanced Accuracy: 0.8583
   Precision: 0.9167
   Recall: 0.9167
   F1-Score: 0.9167

üîç PREDICTION CONFIDENCE ANALYSIS - VALIDATION
============================================================
üìä Confidence Statistics:
   Mean confidence: 0.7391
   Median confidence: 0.7032
   Min confidence: 0.5003
   Max confidence: 0.9680

üö® Overconfidence Detection:
   Predictions with >95% confidence: 10/204 (4.9%)
   Predictions with >99% confidence: 0/204 (0.0%)
   ‚úÖ Confidence levels appear reasonable

üìà Confidence-Accuracy Correlation:
   Accuracy on high-confidence predictions: 1.0000
   Accuracy on lower-confidence predictions: 0.8763
   ‚ö†Ô∏è  Poor calibration - confidence doesn't match accuracy

================================================================================
üß™ FINAL TEST EVALUATION
================================================================================
üö® These patients were NEVER seen during training or validation
üéØ FINAL TEST RESULTS:
   Accuracy: 0.9500
   Balanced Accuracy: 0.9167
   Precision: 0.9333
   Recall: 1.0000
   F1-Score: 0.9655

üîç Final Test Confusion Matrix:
   [[TN=60, FP=12],
    [FN=0, TP=168]]

üîç PREDICTION CONFIDENCE ANALYSIS - TEST
============================================================
üìä Confidence Statistics:
   Mean confidence: 0.8073
   Median confidence: 0.8366
   Min confidence: 0.5383
   Max confidence: 0.9802

üö® Overconfidence Detection:
   Predictions with >95% confidence: 1/240 (0.4%)
   Predictions with >99% confidence: 0/240 (0.0%)
   ‚úÖ Confidence levels appear reasonable

üìà Confidence-Accuracy Correlation:
   Accuracy on high-confidence predictions: 1.0000
   Accuracy on lower-confidence predictions: 0.9498
   ‚úÖ Good calibration - confidence matches accuracy

üìã Final Test Classification Report:
              precision    recall  f1-score   support

      Benign       1.00      0.83      0.91        72
   Malignant       0.93      1.00      0.97       168

    accuracy                           0.95       240
   macro avg       0.97      0.92      0.94       240
weighted avg       0.95      0.95      0.95       240


====================================================================================================
üìä CROSS-CONFIGURATION COMPARISON
====================================================================================================

üìà Test Accuracy Across Configurations:
   balanced_large_test: 0.8235 (17 patients)
   moderate_test: 0.9833 (15 patients)
   large_test: 0.9500 (20 patients)

üîç Consistency Analysis:
   Mean test accuracy: 0.9190
   Standard deviation: 0.0843
   ‚ö†Ô∏è  High variability - may indicate dataset issues
   ‚úÖ Realistic medical AI performance achieved

üìÅ Detailed results saved to: robust_holdout_comparison.csv

üéâ Robust holdout evaluation completed!