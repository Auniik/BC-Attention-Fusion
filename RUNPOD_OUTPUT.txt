Dataset Statistics:
--------------------------------------------------------------------------------
Category                                 Images     Patients
--------------------------------------------------------------------------------
benign_adenosis_100X                     113        4
benign_adenosis_200X                     111        4
benign_adenosis_400X                     106        4
benign_adenosis_40X                      114        4
benign_fibroadenoma_100X                 260        10
benign_fibroadenoma_200X                 264        10
benign_fibroadenoma_400X                 237        10
benign_fibroadenoma_40X                  253        10
benign_phyllodes_tumor_100X              121        3
benign_phyllodes_tumor_200X              108        3
benign_phyllodes_tumor_400X              115        3
benign_phyllodes_tumor_40X               109        3
benign_tubular_adenoma_100X              150        7
benign_tubular_adenoma_200X              140        7
benign_tubular_adenoma_400X              130        7
benign_tubular_adenoma_40X               149        7
malignant_ductal_carcinoma_100X          903        38
malignant_ductal_carcinoma_200X          896        38
malignant_ductal_carcinoma_400X          788        38
malignant_ductal_carcinoma_40X           864        38
malignant_lobular_carcinoma_100X         170        5
malignant_lobular_carcinoma_200X         163        5
malignant_lobular_carcinoma_400X         137        5
malignant_lobular_carcinoma_40X          156        5
malignant_mucinous_carcinoma_100X        222        9
malignant_mucinous_carcinoma_200X        196        9
malignant_mucinous_carcinoma_400X        169        9
malignant_mucinous_carcinoma_40X         205        9
malignant_papillary_carcinoma_100X       142        6
malignant_papillary_carcinoma_200X       135        6
malignant_papillary_carcinoma_400X       138        6
malignant_papillary_carcinoma_40X        145        6

Folds.csv Info:
Shape: (197725, 4)

Columns: ['fold', 'mag', 'grp', 'filename']

First few rows:
   fold  mag    grp                                           filename
0     1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
1     1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
2     1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
3     1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
4     1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...

Fold distribution:
fold
1    39545
2    39545
3    39545
4    39545
5    39545
Name: count, dtype: int64

Magnification distribution:
mag
100    52025
200    50325
40     49875
400    45500
Name: count, dtype: int64

Train/Test distribution:
grp
train    158180
test      39545
Name: count, dtype: int64
        fold  mag    grp                                           filename
0          1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
1          1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
2          1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
3          1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
4          1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
...      ...  ...    ...                                                ...
197720     5  400  train  BreaKHis_v1/histology_slides/breast/malignant/...
197721     5  400  train  BreaKHis_v1/histology_slides/breast/malignant/...
197722     5  400  train  BreaKHis_v1/histology_slides/breast/malignant/...
197723     5  400  train  BreaKHis_v1/histology_slides/breast/malignant/...
197724     5  400  train  BreaKHis_v1/histology_slides/breast/malignant/...

[197725 rows x 4 columns]
Dataset structure analysis:
Unique patients: 82

Tumor types distribution:
tumor_class  tumor_type
benign       adenosis               11100
             fibroadenoma           25350
             phyllodes_tumor        11325
             tubular_adenoma        14225
malignant    ductal_carcinoma       86275
             lobular_carcinoma      15650
             mucinous_carcinoma     19800
             papillary_carcinoma    14000
dtype: int64

Patients by number of magnifications available:
magnification
4    82
Name: count, dtype: int64

Images per patient-magnification (sample):
patient_id          magnification
SOB_B_A_14-22549AB  40               725
                    100              750
                    200              800
                    400              750
SOB_B_A_14-22549CD  40               875
                    100              900
                    200              775
                    400              750
SOB_B_A_14-22549G   40               875
                    100              850
                    200              800
                    400              725
SOB_B_A_14-29960CD  40               375
                    100              325
                    200              400
                    400              425
SOB_B_F_14-14134    40               900
                    100              775
                    200              950
                    400              925
dtype: int64

============================================================
FOLD 1 ANALYSIS
============================================================
=== CLASS DISTRIBUTION ANALYSIS ===

Class distribution by split:
tumor_class  benign  malignant
grp
test           3400       5260
train          9000      21885

Class ratio (benign:malignant) in train: 9000:21885

=== TUMOR TYPE DISTRIBUTION ===
tumor_class  tumor_type
benign       adenosis                1570
             fibroadenoma            3495
             phyllodes_tumor         1090
             tubular_adenoma         2845
malignant    ductal_carcinoma       14375
             lobular_carcinoma       1990
             mucinous_carcinoma      3045
             papillary_carcinoma     2475
dtype: int64

=== PATIENT-LEVEL ANALYSIS ===
Unique patients - Benign: 24, Malignant: 58

Images per patient stats:
Mean: 475.2, Std: 179.0

=== MAGNIFICATION BALANCE ===
mag           40    100   200   400
tumor_class
benign       2290  2295  2275  2140
malignant    5580  5750  5630  4925

=== CALCULATED WEIGHTS ===
Class weights: {'malignant': 0.705620287868403, 'benign': 1.7158333333333333}

Tumor type weights (top 5):
  phyllodes_tumor: 3.542
  adenosis: 2.459
  lobular_carcinoma: 1.940
  papillary_carcinoma: 1.560
  tubular_adenoma: 1.357

üìà Dataset Statistics:
   Total patients with all magnifications: 82
   Training samples: 119000
   Test samples: 44475
üîç Mode 'train' filtering:
   Total available patients: 82
   Patients with train samples: 50
   Filtered patients for train: 50
   ‚úÖ No patient overlap between train and test
üîç Mode 'val' filtering:
   Total available patients: 82
   Patients with val samples: 15
   Filtered patients for val: 15
üîç Mode 'test' filtering:
   Total available patients: 82
   Patients with test samples: 17
   Filtered patients for test: 17

üéØ Patient Splits:
   Train: 50 patients
   Validation: 15 patients
   Test: 17 patients

üèóÔ∏è  Creating datasets with advanced configuration...
Balanced dataset: 420 benign, 420 malignant
Dataset initialized:
  Mode: train
  Patients: 50
  Samples per epoch: 840
  Magnifications: ['40', '100', '200', '400']
Dataset initialized:
  Mode: val
  Patients: 15
  Samples per epoch: 120
  Magnifications: ['40', '100', '200', '400']
Dataset initialized:
  Mode: test
  Patients: 17
  Samples per epoch: 136
  Magnifications: ['40', '100', '200', '400']

üìä Dataset Sizes (Optimized for Advanced Model):
   Train: 840 samples
   Validation: 120 samples
   Test: 136 samples

üß† Initializing Advanced Attention Model...
üöÄ Initializing AdvancedMultiMagAttentionNet with 4 magnifications
üìä Feature dimensions: 1408 channels, 7x7 spatial
‚úÖ Model initialized successfully!

üèóÔ∏è  AdvancedMultiMagAttentionNet Architecture Summary
======================================================================
üìä Input: 4 magnifications (40x, 100x, 200x, 400x)
üß† Backbone: EfficientNet-B2 per magnification
üéØ Feature dimension: 1408
‚ö° Total parameters: 79,152,306
üîß Trainable parameters: 79,152,306

üîç Attention Mechanisms:
   ‚Ä¢ Multi-scale spatial attention (1x, 2x, 4x scales)
   ‚Ä¢ Channel attention (reduction=16)
   ‚Ä¢ Hierarchical magnification attention (8 heads)
   ‚Ä¢ Cross-magnification fusion attention
   ‚Ä¢ Learned magnification importance weights

üìã Classification Heads:
   ‚Ä¢ Binary classification: 2 classes
   ‚Ä¢ Tumor type classification: 8 classes
======================================================================

üöÄ Starting Advanced Attention Training...
   Model: AdvancedMultiMagAttentionNet
   Backbone: efficientnet_b2
   Epochs: 30
   Learning rate: 0.0003
   Batch size: 8
   Mixed precision: True
Starting 30 epoch training with warmup for 3 epochs
Early stopping patience: 8 epochs

Epoch 1/30
--------------------------------------------------
Training: 100%|--------------------------------------------------------------------------------| 105/105 [00:23<00:00,  4.46it/s, loss=0.6918]
Validating: 100%|----------------------------------------------------------------------------------------| 15/15 [00:02<00:00,  6.38it/s]
Train - Loss: 0.6306, Acc: 0.4893, F1: 0.4850, Bal_Acc: 0.4893
Val - Loss: 0.8911, Acc: 0.5333, F1: 0.5333, Bal_Acc: 0.6818
Per-class Acc: (B: 1.0000, M: 0.3636)
Tumor Acc: 0.1333, LR: 0.00e+00
No improvement - Per-class requirement not met (min: 0.3636 < 0.85)

Epoch 2/30
--------------------------------------------------
Training: 100%|--------------------------------------------------------------------------------| 105/105 [00:21<00:00,  4.92it/s, loss=0.5135]
Validating: 100%|----------------------------------------------------------------------------------------| 15/15 [00:02<00:00,  6.57it/s]
Train - Loss: 0.5748, Acc: 0.4988, F1: 0.4988, Bal_Acc: 0.4988
Val - Loss: 0.8569, Acc: 0.2667, F1: 0.1123, Bal_Acc: 0.5000
Per-class Acc: (B: 1.0000, M: 0.0000)
Tumor Acc: 0.0667, LR: 1.67e-04
No improvement - Per-class requirement not met (min: 0.0000 < 0.85)

Epoch 3/30
--------------------------------------------------
Training: 100%|--------------------------------------------------------------------------------| 105/105 [00:21<00:00,  4.80it/s, loss=0.5619]
Validating: 100%|----------------------------------------------------------------------------------------| 15/15 [00:02<00:00,  6.43it/s]
Train - Loss: 0.5324, Acc: 0.5060, F1: 0.5049, Bal_Acc: 0.5060
Val - Loss: 0.8481, Acc: 0.2667, F1: 0.1123, Bal_Acc: 0.5000
Per-class Acc: (B: 1.0000, M: 0.0000)
Tumor Acc: 0.0667, LR: 3.33e-04
No improvement - Per-class requirement not met (min: 0.0000 < 0.85)

Epoch 4/30
--------------------------------------------------
Training: 100%|--------------------------------------------------------------------------------| 105/105 [00:21<00:00,  4.88it/s, loss=0.5500]
Validating: 100%|----------------------------------------------------------------------------------------| 15/15 [00:02<00:00,  6.46it/s]
Train - Loss: 0.5349, Acc: 0.4738, F1: 0.4731, Bal_Acc: 0.4738
Val - Loss: 0.8730, Acc: 0.2667, F1: 0.1123, Bal_Acc: 0.5000
Per-class Acc: (B: 1.0000, M: 0.0000)
Tumor Acc: 0.0667, LR: 5.00e-04
No improvement - Per-class requirement not met (min: 0.0000 < 0.85)

Epoch 5/30
--------------------------------------------------
Training: 100%|--------------------------------------------------------------------------------| 105/105 [00:21<00:00,  4.78it/s, loss=0.5740]
Validating: 100%|----------------------------------------------------------------------------------------| 15/15 [00:02<00:00,  6.02it/s]
Train - Loss: 0.5220, Acc: 0.4976, F1: 0.4975, Bal_Acc: 0.4976
Val - Loss: 0.9123, Acc: 0.2667, F1: 0.1123, Bal_Acc: 0.5000
Per-class Acc: (B: 1.0000, M: 0.0000)
Tumor Acc: 0.0667, LR: 4.98e-04
No improvement - Per-class requirement not met (min: 0.0000 < 0.85)

Epoch 6/30
--------------------------------------------------
Training: 100%|--------------------------------------------------------------------------------| 105/105 [00:21<00:00,  4.82it/s, loss=0.5190]
Validating: 100%|----------------------------------------------------------------------------------------| 15/15 [00:02<00:00,  5.94it/s]
Train - Loss: 0.5236, Acc: 0.4929, F1: 0.4917, Bal_Acc: 0.4929
Val - Loss: 0.8192, Acc: 0.7333, F1: 0.6205, Bal_Acc: 0.5000
Per-class Acc: (B: 0.0000, M: 1.0000)
Tumor Acc: 0.0667, LR: 4.93e-04
No improvement - Per-class requirement not met (min: 0.0000 < 0.85)

Epoch 7/30
--------------------------------------------------
Training: 100%|--------------------------------------------------------------------------------| 105/105 [00:21<00:00,  4.78it/s, loss=0.4971]
Validating: 100%|----------------------------------------------------------------------------------------| 15/15 [00:02<00:00,  6.01it/s]
Train - Loss: 0.5222, Acc: 0.5226, F1: 0.5225, Bal_Acc: 0.5226
Val - Loss: 0.7935, Acc: 0.7333, F1: 0.6205, Bal_Acc: 0.5000
Per-class Acc: (B: 0.0000, M: 1.0000)
Tumor Acc: 0.5333, LR: 4.85e-04
No improvement - Per-class requirement not met (min: 0.0000 < 0.85)

Epoch 8/30
--------------------------------------------------
Training: 100%|--------------------------------------------------------------------------------| 105/105 [00:22<00:00,  4.74it/s, loss=0.5092]
Validating: 100%|----------------------------------------------------------------------------------------| 15/15 [00:02<00:00,  6.02it/s]
Train - Loss: 0.5203, Acc: 0.5048, F1: 0.5035, Bal_Acc: 0.5048
Val - Loss: 0.8613, Acc: 0.2667, F1: 0.1123, Bal_Acc: 0.5000
Per-class Acc: (B: 1.0000, M: 0.0000)
Tumor Acc: 0.0667, LR: 4.73e-04
No improvement - Per-class requirement not met (min: 0.0000 < 0.85)

‚èπÔ∏è Early stopping triggered after 8 epochs
Best standard accuracy: 0.0000
Best balanced accuracy: 0.0000

====================================================================================================
üîç ADVANCED ATTENTION ANALYSIS
====================================================================================================

üîç ATTENTION PATTERN ANALYSIS - VALIDATION
======================================================================
üìä Learned Magnification Importance:
   1. 200x: 0.250 ü•á
   2. 40x: 0.250 ü•à
   3. 100x: 0.250 ü•â
   4. 400x: 0.250 üìç

üéØ Spatial Attention Analysis:
   40x attention focus: min=0.419, max=0.424
   100x attention focus: min=0.487, max=0.496
   200x attention focus: min=0.477, max=0.499
   400x attention focus: min=0.345, max=0.356

üîç ATTENTION PATTERN ANALYSIS - TEST
======================================================================
üìä Learned Magnification Importance:
   1. 200x: 0.250 ü•á
   2. 40x: 0.250 ü•à
   3. 100x: 0.250 ü•â
   4. 400x: 0.250 üìç

üéØ Spatial Attention Analysis:
   40x attention focus: min=0.413, max=0.420
   100x attention focus: min=0.490, max=0.496
   200x attention focus: min=0.474, max=0.503
   400x attention focus: min=0.342, max=0.362

====================================================================================================
üß™ FINAL TEST EVALUATION WITH ATTENTION ANALYSIS
====================================================================================================
/usr/local/lib/python3.11/dist-packages/sklearn/metrics/_classification.py:1731: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 due to no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f"{metric.capitalize()} is", result.shape[0])
üéØ FINAL ADVANCED ATTENTION RESULTS:
   Accuracy: 0.2941
   Balanced Accuracy: 0.5000
   Precision: 0.0000
   Recall: 0.0000
   F1-Score: 0.0000

üîç Final Confusion Matrix:
   [[TN=40, FP=0],
    [FN=96, TP=0]]

üìã Classification Report:
/usr/local/lib/python3.11/dist-packages/sklearn/metrics/_classification.py:1731: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f"{metric.capitalize()} is", result.shape[0])
/usr/local/lib/python3.11/dist-packages/sklearn/metrics/_classification.py:1731: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f"{metric.capitalize()} is", result.shape[0])
/usr/local/lib/python3.11/dist-packages/sklearn/metrics/_classification.py:1731: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f"{metric.capitalize()} is", result.shape[0])
              precision    recall  f1-score   support

      Benign       0.29      1.00      0.45        40
   Malignant       0.00      0.00      0.00        96

    accuracy                           0.29       136
   macro avg       0.15      0.50      0.23       136
weighted avg       0.09      0.29      0.13       136


====================================================================================================
üèÜ ADVANCED ATTENTION TRAINING COMPLETE
====================================================================================================
‚úÖ State-of-the-art attention mechanisms implemented
‚úÖ Hierarchical magnification attention (40x‚Üí100x‚Üí200x‚Üí400x)
‚úÖ Multi-scale spatial attention with channel attention
‚úÖ Learnable magnification importance weights
‚úÖ Comprehensive attention visualization

üéØ Final Performance:
   Test Accuracy: 29.4%
   Balanced Accuracy: 50.0%
   F1-Score: 0.0%

üî¨ Journal Publication Quality:
   üìä Performance: 29.4% - assess model/data

üìÅ Results saved to: advanced_attention_results.csv
üé® Attention visualizations available via model.get_attention_maps()
====================================================================================================

üéâ Advanced attention-guided multi-magnification training completed!
üèÜ Ready for journal publication with SOTA attention mechanisms!