Dataset Statistics:
--------------------------------------------------------------------------------
Category                                 Images     Patients
--------------------------------------------------------------------------------
benign_adenosis_100X                     113        4
benign_adenosis_200X                     111        4
benign_adenosis_400X                     106        4
benign_adenosis_40X                      114        4
benign_fibroadenoma_100X                 260        10
benign_fibroadenoma_200X                 264        10
benign_fibroadenoma_400X                 237        10
benign_fibroadenoma_40X                  253        10
benign_phyllodes_tumor_100X              121        3
benign_phyllodes_tumor_200X              108        3
benign_phyllodes_tumor_400X              115        3
benign_phyllodes_tumor_40X               109        3
benign_tubular_adenoma_100X              150        7
benign_tubular_adenoma_200X              140        7
benign_tubular_adenoma_400X              130        7
benign_tubular_adenoma_40X               149        7
malignant_ductal_carcinoma_100X          903        38
malignant_ductal_carcinoma_200X          896        38
malignant_ductal_carcinoma_400X          788        38
malignant_ductal_carcinoma_40X           864        38
malignant_lobular_carcinoma_100X         170        5
malignant_lobular_carcinoma_200X         163        5
malignant_lobular_carcinoma_400X         137        5
malignant_lobular_carcinoma_40X          156        5
malignant_mucinous_carcinoma_100X        222        9
malignant_mucinous_carcinoma_200X        196        9
malignant_mucinous_carcinoma_400X        169        9
malignant_mucinous_carcinoma_40X         205        9
malignant_papillary_carcinoma_100X       142        6
malignant_papillary_carcinoma_200X       135        6
malignant_papillary_carcinoma_400X       138        6
malignant_papillary_carcinoma_40X        145        6

Folds.csv Info:
Shape: (39545, 4)

Columns: ['fold', 'mag', 'grp', 'filename']

First few rows:
   fold  mag    grp                                           filename
0     1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
1     1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
2     1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
3     1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
4     1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...

Fold distribution:
fold
1    7909
2    7909
3    7909
4    7909
5    7909
Name: count, dtype: int64

Magnification distribution:
mag
100    10405
200    10065
40      9975
400     9100
Name: count, dtype: int64

Train/Test distribution:
grp
train    25880
test     13665
Name: count, dtype: int64
       fold  mag    grp                                           filename
0         1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
1         1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
2         1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
3         1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
4         1  100  train  BreaKHis_v1/histology_slides/breast/benign/SOB...
...     ...  ...    ...                                                ...
39540     5  400   test  BreaKHis_v1/histology_slides/breast/malignant/...
39541     5  400   test  BreaKHis_v1/histology_slides/breast/malignant/...
39542     5  400   test  BreaKHis_v1/histology_slides/breast/malignant/...
39543     5  400   test  BreaKHis_v1/histology_slides/breast/malignant/...
39544     5  400   test  BreaKHis_v1/histology_slides/breast/malignant/...

[39545 rows x 4 columns]
Dataset structure analysis:
Unique patients: 82

Tumor types distribution:
tumor_class  tumor_type
benign       adenosis                2220
             fibroadenoma            5070
             phyllodes_tumor         2265
             tubular_adenoma         2845
malignant    ductal_carcinoma       17255
             lobular_carcinoma       3130
             mucinous_carcinoma      3960
             papillary_carcinoma     2800
dtype: int64

Patients by number of magnifications available:
magnification
4    82
Name: count, dtype: int64

Images per patient-magnification (sample):
patient_id          magnification
SOB_B_A_14-22549AB  40               145
                    100              150
                    200              160
                    400              150
SOB_B_A_14-22549CD  40               175
                    100              180
                    200              155
                    400              150
SOB_B_A_14-22549G   40               175
                    100              170
                    200              160
                    400              145
SOB_B_A_14-29960CD  40                75
                    100               65
                    200               80
                    400               85
SOB_B_F_14-14134    40               180
                    100              155
                    200              190
                    400              185
dtype: int64

============================================================
FOLD 1 ANALYSIS
============================================================
=== CLASS DISTRIBUTION ANALYSIS ===

Class distribution by split:
tumor_class  benign  malignant
grp
test           1008       1896
train          1472       3533

Class ratio (benign:malignant) in train: 1472:3533

=== TUMOR TYPE DISTRIBUTION ===
tumor_class  tumor_type
benign       adenosis                253
             fibroadenoma            683
             phyllodes_tumor         218
             tubular_adenoma         318
malignant    ductal_carcinoma       2313
             lobular_carcinoma       302
             mucinous_carcinoma      547
             papillary_carcinoma     371
dtype: int64

=== PATIENT-LEVEL ANALYSIS ===
Unique patients - Benign: 24, Malignant: 58

Images per patient stats:
Mean: 92.7, Std: 34.9

=== MAGNIFICATION BALANCE ===
mag          40   100  200  400
tumor_class
benign       370  383  368  351
malignant    880  938  901  814

=== CALCULATED WEIGHTS ===
Class weights: {'malignant': 0.7083215397679027, 'benign': 1.7000679347826086}

Tumor type weights (top 5):
  phyllodes_tumor: 2.870
  adenosis: 2.473
  lobular_carcinoma: 2.072
  tubular_adenoma: 1.967
  papillary_carcinoma: 1.686
🔧 Environment detected: runpod
🎯 Device: cuda
🚀 CUDA available with 1 GPU(s)
⚡ Tensor core optimization enabled for NVIDIA GeForce RTX 4090
📊 Batch size: 16 | Workers: 8
model.safetensors: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 36.8M/36.8M [00:00<00:00, 117MB/s]
==== Fold 1 ====
Balanced dataset: 624 benign, 624 malignant
Dataset initialized:
  Mode: train
  Patients: 82
  Samples per epoch: 1248
  Magnifications: [40, 100, 200, 400]
Dataset initialized:
  Mode: test
  Patients: 82
  Samples per epoch: 112
  Magnifications: [40, 100, 200, 400]
📈 Using batch size: 16 | Workers: 8 | Environment: runpod
Starting training...
Starting 25 epoch training with warmup for 3 epochs
Early stopping patience: 8 epochs

Epoch 1/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:27<00:00,  2.81it/s, loss=0.7573]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:18<00:00,  2.57s/it]
Train - Loss: 0.9194, Acc: 0.5216, F1: 0.5199, Bal_Acc: 0.5216
Val - Loss: 1.1514, Acc: 0.5268, F1: 0.5250, Bal_Acc: 0.4539
Detailed Bal_Acc: 0.4539 (B: 0.2500, M: 0.6579)
Tumor Acc: 0.1429, LR: 0.00e+00
🎯 New best balanced accuracy: 0.4539 - Model saved!

Epoch 2/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  7.93it/s, loss=0.4746]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  7.84it/s]
Train - Loss: 0.5861, Acc: 0.8405, F1: 0.8404, Bal_Acc: 0.8405
Val - Loss: 0.8389, Acc: 0.8661, F1: 0.8693, Bal_Acc: 0.8794
Detailed Bal_Acc: 0.8794 (B: 0.9167, M: 0.8421)
Tumor Acc: 0.6071, LR: 1.67e-04
🎯 New best balanced accuracy: 0.8794 - Model saved!

Epoch 3/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.22it/s, loss=0.3117]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  8.21it/s]
Train - Loss: 0.4010, Acc: 0.9367, F1: 0.9366, Bal_Acc: 0.9367
Val - Loss: 0.7183, Acc: 0.9643, F1: 0.9645, Bal_Acc: 0.9664
Detailed Bal_Acc: 0.9664 (B: 0.9722, M: 0.9605)
Tumor Acc: 0.6161, LR: 3.33e-04
🎯 New best balanced accuracy: 0.9664 - Model saved!

Epoch 4/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.32it/s, loss=0.5228]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  8.31it/s]
Train - Loss: 0.3614, Acc: 0.9495, F1: 0.9495, Bal_Acc: 0.9495
Val - Loss: 0.7368, Acc: 0.9107, F1: 0.9092, Bal_Acc: 0.8830
Detailed Bal_Acc: 0.8830 (B: 0.8056, M: 0.9605)
Tumor Acc: 0.6071, LR: 5.00e-04
No improvement for 1/8 epochs

Epoch 5/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.15it/s, loss=0.5861]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  8.81it/s]
Train - Loss: 0.3136, Acc: 0.9752, F1: 0.9752, Bal_Acc: 0.9752
Val - Loss: 0.7844, Acc: 0.9286, F1: 0.9291, Bal_Acc: 0.9254
Detailed Bal_Acc: 0.9254 (B: 0.9167, M: 0.9342)
Tumor Acc: 0.5536, LR: 4.97e-04
No improvement for 2/8 epochs

Epoch 6/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.34it/s, loss=0.3648]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  8.97it/s]
Train - Loss: 0.3103, Acc: 0.9647, F1: 0.9647, Bal_Acc: 0.9647
Val - Loss: 0.7030, Acc: 0.9464, F1: 0.9468, Bal_Acc: 0.9459
Detailed Bal_Acc: 0.9459 (B: 0.9444, M: 0.9474)
Tumor Acc: 0.5357, LR: 4.90e-04
No improvement for 3/8 epochs

Epoch 7/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.22it/s, loss=0.2172]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  8.89it/s]
Train - Loss: 0.3034, Acc: 0.9663, F1: 0.9663, Bal_Acc: 0.9663
Val - Loss: 0.6833, Acc: 0.9554, F1: 0.9555, Bal_Acc: 0.9525
Detailed Bal_Acc: 0.9525 (B: 0.9444, M: 0.9605)
Tumor Acc: 0.5714, LR: 4.77e-04
No improvement for 4/8 epochs

Epoch 8/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.49it/s, loss=0.2822]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  9.21it/s]
Train - Loss: 0.3088, Acc: 0.9671, F1: 0.9671, Bal_Acc: 0.9671
Val - Loss: 0.8450, Acc: 0.9196, F1: 0.9213, Bal_Acc: 0.9335
Detailed Bal_Acc: 0.9335 (B: 0.9722, M: 0.8947)
Tumor Acc: 0.4643, LR: 4.60e-04
No improvement for 5/8 epochs

Epoch 9/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.32it/s, loss=0.2666]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  9.06it/s]
Train - Loss: 0.2878, Acc: 0.9720, F1: 0.9719, Bal_Acc: 0.9720
Val - Loss: 0.6781, Acc: 0.9643, F1: 0.9640, Bal_Acc: 0.9518
Detailed Bal_Acc: 0.9518 (B: 0.9167, M: 0.9868)
Tumor Acc: 0.5446, LR: 4.39e-04
No improvement for 6/8 epochs

Epoch 10/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  7.98it/s, loss=0.5975]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  9.40it/s]
Train - Loss: 0.2683, Acc: 0.9808, F1: 0.9808, Bal_Acc: 0.9808
Val - Loss: 0.8154, Acc: 0.9196, F1: 0.9209, Bal_Acc: 0.9262
Detailed Bal_Acc: 0.9262 (B: 0.9444, M: 0.9079)
Tumor Acc: 0.5089, LR: 4.14e-04
No improvement for 7/8 epochs

Epoch 11/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.28it/s, loss=0.4164]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  9.33it/s]
Train - Loss: 0.2648, Acc: 0.9824, F1: 0.9824, Bal_Acc: 0.9824
Val - Loss: 0.7257, Acc: 0.9107, F1: 0.9107, Bal_Acc: 0.8977
Detailed Bal_Acc: 0.8977 (B: 0.8611, M: 0.9342)
Tumor Acc: 0.5446, LR: 3.85e-04
No improvement for 8/8 epochs

⏹️ Early stopping triggered after 11 epochs
Best balanced accuracy: 0.9664

=== DETAILED CLASSIFICATION REPORT ===
              precision    recall  f1-score   support

      benign     0.8611    0.8611    0.8611        36
   malignant     0.9342    0.9342    0.9342        76

    accuracy                         0.9107       112
   macro avg     0.8977    0.8977    0.8977       112
weighted avg     0.9107    0.9107    0.9107       112


=== CONFUSION MATRIX ===
Predicted:  benign  malignant
benign:         31        5
malignant:       5       71

=== KEY INSIGHTS ===
Benign Recall: 0.8611 (31/36)
Malignant Recall: 0.9342 (71/76)

Prediction distribution: benign=36, malignant=76
Analyzing cross-magnification feature importance...

Final Validation Accuracy: 0.9643

Magnification Importance Analysis:
40x contribution: 0.0290 ± 0.0721
100x contribution: 0.0197 ± 0.0513
200x contribution: 0.0147 ± 0.0714
400x contribution: 0.0167 ± 0.0780
==== Fold 2 ====
Balanced dataset: 624 benign, 624 malignant
Dataset initialized:
  Mode: train
  Patients: 82
  Samples per epoch: 1248
  Magnifications: [40, 100, 200, 400]
Dataset initialized:
  Mode: test
  Patients: 82
  Samples per epoch: 112
  Magnifications: [40, 100, 200, 400]
📈 Using batch size: 16 | Workers: 8 | Environment: runpod
Starting training...
Starting 25 epoch training with warmup for 3 epochs
Early stopping patience: 8 epochs

Epoch 1/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:27<00:00,  2.89it/s, loss=0.4113]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:17<00:00,  2.50s/it]
Train - Loss: 0.3891, Acc: 0.9487, F1: 0.9487, Bal_Acc: 0.9487
Val - Loss: 0.6566, Acc: 0.9464, F1: 0.9468, Bal_Acc: 0.9459
Detailed Bal_Acc: 0.9459 (B: 0.9444, M: 0.9474)
Tumor Acc: 0.6875, LR: 0.00e+00
🎯 New best balanced accuracy: 0.9459 - Model saved!

Epoch 2/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.14it/s, loss=0.4374]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  9.68it/s]
Train - Loss: 0.3741, Acc: 0.9463, F1: 0.9463, Bal_Acc: 0.9463
Val - Loss: 0.8233, Acc: 0.8393, F1: 0.8444, Bal_Acc: 0.8743
Detailed Bal_Acc: 0.8743 (B: 0.9722, M: 0.7763)
Tumor Acc: 0.5625, LR: 1.67e-04
No improvement for 1/8 epochs

Epoch 3/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  7.93it/s, loss=0.3585]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  9.27it/s]
Train - Loss: 0.3708, Acc: 0.9383, F1: 0.9383, Bal_Acc: 0.9383
Val - Loss: 1.1228, Acc: 0.7589, F1: 0.7658, Bal_Acc: 0.8224
Detailed Bal_Acc: 0.8224 (B: 1.0000, M: 0.6447)
Tumor Acc: 0.5268, LR: 3.33e-04
No improvement for 2/8 epochs

Epoch 4/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.27it/s, loss=0.2958]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  8.86it/s]
Train - Loss: 0.3940, Acc: 0.9359, F1: 0.9359, Bal_Acc: 0.9359
Val - Loss: 0.7429, Acc: 0.9375, F1: 0.9385, Bal_Acc: 0.9466
Detailed Bal_Acc: 0.9466 (B: 0.9722, M: 0.9211)
Tumor Acc: 0.6429, LR: 5.00e-04
🎯 New best balanced accuracy: 0.9466 - Model saved!

Epoch 5/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.12it/s, loss=0.2783]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  8.67it/s]
Train - Loss: 0.3931, Acc: 0.9311, F1: 0.9310, Bal_Acc: 0.9311
Val - Loss: 1.0008, Acc: 0.9018, F1: 0.9033, Bal_Acc: 0.9057
Detailed Bal_Acc: 0.9057 (B: 0.9167, M: 0.8947)
Tumor Acc: 0.5268, LR: 4.97e-04
No improvement for 1/8 epochs

Epoch 6/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.07it/s, loss=0.4879]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  8.87it/s]
Train - Loss: 0.3843, Acc: 0.9463, F1: 0.9463, Bal_Acc: 0.9463
Val - Loss: 0.7335, Acc: 0.9286, F1: 0.9291, Bal_Acc: 0.9254
Detailed Bal_Acc: 0.9254 (B: 0.9167, M: 0.9342)
Tumor Acc: 0.5893, LR: 4.90e-04
No improvement for 2/8 epochs

Epoch 7/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.04it/s, loss=0.3047]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  9.39it/s]
Train - Loss: 0.3629, Acc: 0.9487, F1: 0.9487, Bal_Acc: 0.9487
Val - Loss: 0.7357, Acc: 0.9107, F1: 0.9100, Bal_Acc: 0.8904
Detailed Bal_Acc: 0.8904 (B: 0.8333, M: 0.9474)
Tumor Acc: 0.5714, LR: 4.77e-04
No improvement for 3/8 epochs

Epoch 8/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.16it/s, loss=0.4096]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  9.36it/s]
Train - Loss: 0.3389, Acc: 0.9647, F1: 0.9647, Bal_Acc: 0.9647
Val - Loss: 0.7725, Acc: 0.9107, F1: 0.9113, Bal_Acc: 0.9050
Detailed Bal_Acc: 0.9050 (B: 0.8889, M: 0.9211)
Tumor Acc: 0.5804, LR: 4.60e-04
No improvement for 4/8 epochs

Epoch 9/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.01it/s, loss=0.4970]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  9.38it/s]
Train - Loss: 0.3546, Acc: 0.9519, F1: 0.9519, Bal_Acc: 0.9519
Val - Loss: 0.7857, Acc: 0.9464, F1: 0.9468, Bal_Acc: 0.9459
Detailed Bal_Acc: 0.9459 (B: 0.9444, M: 0.9474)
Tumor Acc: 0.6161, LR: 4.39e-04
No improvement for 5/8 epochs

Epoch 10/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  7.83it/s, loss=0.4767]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  9.06it/s]
Train - Loss: 0.3278, Acc: 0.9655, F1: 0.9655, Bal_Acc: 0.9655
Val - Loss: 0.7267, Acc: 0.9286, F1: 0.9299, Bal_Acc: 0.9401
Detailed Bal_Acc: 0.9401 (B: 0.9722, M: 0.9079)
Tumor Acc: 0.6518, LR: 4.14e-04
No improvement for 6/8 epochs

Epoch 11/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.21it/s, loss=0.4148]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  9.38it/s]
Train - Loss: 0.3392, Acc: 0.9655, F1: 0.9655, Bal_Acc: 0.9655
Val - Loss: 0.7664, Acc: 0.8929, F1: 0.8936, Bal_Acc: 0.8845
Detailed Bal_Acc: 0.8845 (B: 0.8611, M: 0.9079)
Tumor Acc: 0.6071, LR: 3.85e-04
No improvement for 7/8 epochs

Epoch 12/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.06it/s, loss=0.2648]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  9.20it/s]
Train - Loss: 0.3204, Acc: 0.9679, F1: 0.9679, Bal_Acc: 0.9679
Val - Loss: 0.9439, Acc: 0.8571, F1: 0.8617, Bal_Acc: 0.8947
Detailed Bal_Acc: 0.8947 (B: 1.0000, M: 0.7895)
Tumor Acc: 0.5268, LR: 3.54e-04
No improvement for 8/8 epochs

⏹️ Early stopping triggered after 12 epochs
Best balanced accuracy: 0.9466

=== DETAILED CLASSIFICATION REPORT ===
              precision    recall  f1-score   support

      benign     0.6923    1.0000    0.8182        36
   malignant     1.0000    0.7895    0.8824        76

    accuracy                         0.8571       112
   macro avg     0.8462    0.8947    0.8503       112
weighted avg     0.9011    0.8571    0.8617       112


=== CONFUSION MATRIX ===
Predicted:  benign  malignant
benign:         36        0
malignant:      16       60

=== KEY INSIGHTS ===
Benign Recall: 1.0000 (36/36)
Malignant Recall: 0.7895 (60/76)

Prediction distribution: benign=52, malignant=60
Analyzing cross-magnification feature importance...

Final Validation Accuracy: 0.9286

Magnification Importance Analysis:
40x contribution: 0.0336 ± 0.0672
100x contribution: 0.0261 ± 0.0687
200x contribution: 0.0312 ± 0.0567
400x contribution: 0.0197 ± 0.0595
==== Fold 3 ====
Balanced dataset: 624 benign, 624 malignant
Dataset initialized:
  Mode: train
  Patients: 82
  Samples per epoch: 1248
  Magnifications: [40, 100, 200, 400]
Dataset initialized:
  Mode: test
  Patients: 82
  Samples per epoch: 112
  Magnifications: [40, 100, 200, 400]
📈 Using batch size: 16 | Workers: 8 | Environment: runpod
Starting training...
Starting 25 epoch training with warmup for 3 epochs
Early stopping patience: 8 epochs

Epoch 1/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:26<00:00,  2.94it/s, loss=0.6379]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:17<00:00,  2.53s/it]
Train - Loss: 0.4919, Acc: 0.8822, F1: 0.8821, Bal_Acc: 0.8822
Val - Loss: 0.6150, Acc: 0.9643, F1: 0.9647, Bal_Acc: 0.9737
Detailed Bal_Acc: 0.9737 (B: 1.0000, M: 0.9474)
Tumor Acc: 0.6161, LR: 0.00e+00
🎯 New best balanced accuracy: 0.9737 - Model saved!

Epoch 2/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.26it/s, loss=0.2979]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  9.88it/s]
Train - Loss: 0.3806, Acc: 0.9431, F1: 0.9431, Bal_Acc: 0.9431
Val - Loss: 0.5541, Acc: 0.9732, F1: 0.9735, Bal_Acc: 0.9803
Detailed Bal_Acc: 0.9803 (B: 1.0000, M: 0.9605)
Tumor Acc: 0.6964, LR: 1.67e-04
🎯 New best balanced accuracy: 0.9803 - Model saved!

Epoch 3/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.18it/s, loss=0.3932]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  9.62it/s]
Train - Loss: 0.4129, Acc: 0.9215, F1: 0.9214, Bal_Acc: 0.9215
Val - Loss: 0.7126, Acc: 0.9554, F1: 0.9544, Bal_Acc: 0.9306
Detailed Bal_Acc: 0.9306 (B: 0.8611, M: 1.0000)
Tumor Acc: 0.6161, LR: 3.33e-04
No improvement for 1/8 epochs

Epoch 4/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.25it/s, loss=0.4868]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  9.84it/s]
Train - Loss: 0.3668, Acc: 0.9415, F1: 0.9415, Bal_Acc: 0.9415
Val - Loss: 0.5971, Acc: 0.9643, F1: 0.9647, Bal_Acc: 0.9737
Detailed Bal_Acc: 0.9737 (B: 1.0000, M: 0.9474)
Tumor Acc: 0.6607, LR: 5.00e-04
No improvement for 2/8 epochs

Epoch 5/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.21it/s, loss=0.3690]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  9.25it/s]
Train - Loss: 0.3698, Acc: 0.9399, F1: 0.9399, Bal_Acc: 0.9399
Val - Loss: 0.7177, Acc: 0.9464, F1: 0.9468, Bal_Acc: 0.9459
Detailed Bal_Acc: 0.9459 (B: 0.9444, M: 0.9474)
Tumor Acc: 0.5625, LR: 4.97e-04
No improvement for 3/8 epochs

Epoch 6/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.13it/s, loss=0.3306]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  9.37it/s]
Train - Loss: 0.3929, Acc: 0.9327, F1: 0.9327, Bal_Acc: 0.9327
Val - Loss: 0.7220, Acc: 0.9375, F1: 0.9388, Bal_Acc: 0.9539
Detailed Bal_Acc: 0.9539 (B: 1.0000, M: 0.9079)
Tumor Acc: 0.5179, LR: 4.90e-04
No improvement for 4/8 epochs

Epoch 7/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.15it/s, loss=0.3654]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  9.46it/s]
Train - Loss: 0.3670, Acc: 0.9415, F1: 0.9415, Bal_Acc: 0.9415
Val - Loss: 0.8205, Acc: 0.9107, F1: 0.9119, Bal_Acc: 0.9123
Detailed Bal_Acc: 0.9123 (B: 0.9167, M: 0.9079)
Tumor Acc: 0.4821, LR: 4.77e-04
No improvement for 5/8 epochs

Epoch 8/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.21it/s, loss=0.2583]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  7.50it/s]
Train - Loss: 0.4005, Acc: 0.9263, F1: 0.9262, Bal_Acc: 0.9263
Val - Loss: 0.7930, Acc: 0.9018, F1: 0.9042, Bal_Acc: 0.9203
Detailed Bal_Acc: 0.9203 (B: 0.9722, M: 0.8684)
Tumor Acc: 0.5089, LR: 4.60e-04
No improvement for 6/8 epochs

Epoch 9/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.24it/s, loss=0.2487]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  7.85it/s]
Train - Loss: 0.3458, Acc: 0.9519, F1: 0.9519, Bal_Acc: 0.9519
Val - Loss: 0.7119, Acc: 0.9196, F1: 0.9204, Bal_Acc: 0.9189
Detailed Bal_Acc: 0.9189 (B: 0.9167, M: 0.9211)
Tumor Acc: 0.4911, LR: 4.39e-04
No improvement for 7/8 epochs

Epoch 10/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.22it/s, loss=0.4283]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  9.23it/s]
Train - Loss: 0.3377, Acc: 0.9591, F1: 0.9591, Bal_Acc: 0.9591
Val - Loss: 0.6876, Acc: 0.9286, F1: 0.9291, Bal_Acc: 0.9254
Detailed Bal_Acc: 0.9254 (B: 0.9167, M: 0.9342)
Tumor Acc: 0.5804, LR: 4.14e-04
No improvement for 8/8 epochs

⏹️ Early stopping triggered after 10 epochs
Best balanced accuracy: 0.9803

=== DETAILED CLASSIFICATION REPORT ===
              precision    recall  f1-score   support

      benign     0.8684    0.9167    0.8919        36
   malignant     0.9595    0.9342    0.9467        76

    accuracy                         0.9286       112
   macro avg     0.9139    0.9254    0.9193       112
weighted avg     0.9302    0.9286    0.9291       112


=== CONFUSION MATRIX ===
Predicted:  benign  malignant
benign:         33        3
malignant:       5       71

=== KEY INSIGHTS ===
Benign Recall: 0.9167 (33/36)
Malignant Recall: 0.9342 (71/76)

Prediction distribution: benign=38, malignant=74
Analyzing cross-magnification feature importance...

Final Validation Accuracy: 0.9911

Magnification Importance Analysis:
40x contribution: 0.0354 ± 0.0415
100x contribution: 0.0326 ± 0.0381
200x contribution: 0.0258 ± 0.0483
400x contribution: 0.0218 ± 0.0374
==== Fold 4 ====
Balanced dataset: 624 benign, 624 malignant
Dataset initialized:
  Mode: train
  Patients: 82
  Samples per epoch: 1248
  Magnifications: [40, 100, 200, 400]
Dataset initialized:
  Mode: test
  Patients: 82
  Samples per epoch: 112
  Magnifications: [40, 100, 200, 400]
📈 Using batch size: 16 | Workers: 8 | Environment: runpod
Starting training...
Starting 25 epoch training with warmup for 3 epochs
Early stopping patience: 8 epochs

Epoch 1/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:26<00:00,  2.96it/s, loss=0.3004]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:17<00:00,  2.50s/it]
Train - Loss: 0.3782, Acc: 0.9463, F1: 0.9463, Bal_Acc: 0.9463
Val - Loss: 0.5187, Acc: 0.9911, F1: 0.9911, Bal_Acc: 0.9934
Detailed Bal_Acc: 0.9934 (B: 1.0000, M: 0.9868)
Tumor Acc: 0.7500, LR: 0.00e+00
🎯 New best balanced accuracy: 0.9934 - Model saved!

Epoch 2/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.51it/s, loss=0.2893]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  9.72it/s]
Train - Loss: 0.3477, Acc: 0.9639, F1: 0.9639, Bal_Acc: 0.9639
Val - Loss: 0.5934, Acc: 0.9554, F1: 0.9558, Bal_Acc: 0.9598
Detailed Bal_Acc: 0.9598 (B: 0.9722, M: 0.9474)
Tumor Acc: 0.6964, LR: 1.67e-04
No improvement for 1/8 epochs

Epoch 3/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.02it/s, loss=0.2908]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  9.72it/s]
Train - Loss: 0.3505, Acc: 0.9535, F1: 0.9535, Bal_Acc: 0.9535
Val - Loss: 0.6829, Acc: 0.9375, F1: 0.9373, Bal_Acc: 0.9247
Detailed Bal_Acc: 0.9247 (B: 0.8889, M: 0.9605)
Tumor Acc: 0.6696, LR: 3.33e-04
No improvement for 2/8 epochs

Epoch 4/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.31it/s, loss=0.6682]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  9.62it/s]
Train - Loss: 0.3779, Acc: 0.9335, F1: 0.9334, Bal_Acc: 0.9335
Val - Loss: 0.8699, Acc: 0.8571, F1: 0.8597, Bal_Acc: 0.8582
Detailed Bal_Acc: 0.8582 (B: 0.8611, M: 0.8553)
Tumor Acc: 0.5893, LR: 5.00e-04
No improvement for 3/8 epochs

Epoch 5/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.07it/s, loss=0.5432]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  9.58it/s]
Train - Loss: 0.3727, Acc: 0.9327, F1: 0.9326, Bal_Acc: 0.9327
Val - Loss: 0.8598, Acc: 0.8929, F1: 0.8920, Bal_Acc: 0.8699
Detailed Bal_Acc: 0.8699 (B: 0.8056, M: 0.9342)
Tumor Acc: 0.5268, LR: 4.97e-04
No improvement for 4/8 epochs

Epoch 6/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.22it/s, loss=0.2712]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  9.66it/s]
Train - Loss: 0.3420, Acc: 0.9535, F1: 0.9535, Bal_Acc: 0.9535
Val - Loss: 0.7482, Acc: 0.9196, F1: 0.9187, Bal_Acc: 0.8969
Detailed Bal_Acc: 0.8969 (B: 0.8333, M: 0.9605)
Tumor Acc: 0.5893, LR: 4.90e-04
No improvement for 5/8 epochs

Epoch 7/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.11it/s, loss=0.2451]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  9.57it/s]
Train - Loss: 0.3438, Acc: 0.9535, F1: 0.9535, Bal_Acc: 0.9535
Val - Loss: 0.7586, Acc: 0.8571, F1: 0.8603, Bal_Acc: 0.8655
Detailed Bal_Acc: 0.8655 (B: 0.8889, M: 0.8421)
Tumor Acc: 0.5982, LR: 4.77e-04
No improvement for 6/8 epochs

Epoch 8/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.21it/s, loss=0.4023]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  9.43it/s]
Train - Loss: 0.3326, Acc: 0.9583, F1: 0.9583, Bal_Acc: 0.9583
Val - Loss: 0.7898, Acc: 0.8661, F1: 0.8656, Bal_Acc: 0.8428
Detailed Bal_Acc: 0.8428 (B: 0.7778, M: 0.9079)
Tumor Acc: 0.5714, LR: 4.60e-04
No improvement for 7/8 epochs

Epoch 9/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.25it/s, loss=0.2792]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  9.52it/s]
Train - Loss: 0.3473, Acc: 0.9447, F1: 0.9447, Bal_Acc: 0.9447
Val - Loss: 0.7946, Acc: 0.8750, F1: 0.8766, Bal_Acc: 0.8713
Detailed Bal_Acc: 0.8713 (B: 0.8611, M: 0.8816)
Tumor Acc: 0.5714, LR: 4.39e-04
No improvement for 8/8 epochs

⏹️ Early stopping triggered after 9 epochs
Best balanced accuracy: 0.9934

=== DETAILED CLASSIFICATION REPORT ===
              precision    recall  f1-score   support

      benign     0.7750    0.8611    0.8158        36
   malignant     0.9306    0.8816    0.9054        76

    accuracy                         0.8750       112
   macro avg     0.8528    0.8713    0.8606       112
weighted avg     0.8806    0.8750    0.8766       112


=== CONFUSION MATRIX ===
Predicted:  benign  malignant
benign:         31        5
malignant:       9       67

=== KEY INSIGHTS ===
Benign Recall: 0.8611 (31/36)
Malignant Recall: 0.8816 (67/76)

Prediction distribution: benign=40, malignant=72
Analyzing cross-magnification feature importance...

Final Validation Accuracy: 0.9643

Magnification Importance Analysis:
40x contribution: 0.0278 ± 0.0395
100x contribution: 0.0212 ± 0.0385
200x contribution: 0.0249 ± 0.0575
400x contribution: 0.0187 ± 0.0359
==== Fold 5 ====
Balanced dataset: 624 benign, 624 malignant
Dataset initialized:
  Mode: train
  Patients: 82
  Samples per epoch: 1248
  Magnifications: [40, 100, 200, 400]
Dataset initialized:
  Mode: test
  Patients: 82
  Samples per epoch: 112
  Magnifications: [40, 100, 200, 400]
📈 Using batch size: 16 | Workers: 8 | Environment: runpod
Starting training...
Starting 25 epoch training with warmup for 3 epochs
Early stopping patience: 8 epochs

Epoch 1/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:26<00:00,  2.95it/s, loss=0.3634]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:17<00:00,  2.53s/it]
Train - Loss: 0.3473, Acc: 0.9591, F1: 0.9591, Bal_Acc: 0.9591
Val - Loss: 0.5672, Acc: 0.9732, F1: 0.9735, Bal_Acc: 0.9803
Detailed Bal_Acc: 0.9803 (B: 1.0000, M: 0.9605)
Tumor Acc: 0.7054, LR: 0.00e+00
🎯 New best balanced accuracy: 0.9803 - Model saved!

Epoch 2/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  7.93it/s, loss=0.2726]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  9.37it/s]
Train - Loss: 0.3265, Acc: 0.9679, F1: 0.9679, Bal_Acc: 0.9679
Val - Loss: 0.5771, Acc: 0.9821, F1: 0.9823, Bal_Acc: 0.9868
Detailed Bal_Acc: 0.9868 (B: 1.0000, M: 0.9737)
Tumor Acc: 0.6786, LR: 1.67e-04
🎯 New best balanced accuracy: 0.9868 - Model saved!

Epoch 3/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.18it/s, loss=0.2947]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00, 10.33it/s]
Train - Loss: 0.3733, Acc: 0.9359, F1: 0.9358, Bal_Acc: 0.9359
Val - Loss: 0.6586, Acc: 0.9554, F1: 0.9558, Bal_Acc: 0.9598
Detailed Bal_Acc: 0.9598 (B: 0.9722, M: 0.9474)
Tumor Acc: 0.6250, LR: 3.33e-04
No improvement for 1/8 epochs

Epoch 4/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  7.99it/s, loss=0.3787]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  9.80it/s]
Train - Loss: 0.3965, Acc: 0.9215, F1: 0.9213, Bal_Acc: 0.9215
Val - Loss: 0.7098, Acc: 0.9643, F1: 0.9640, Bal_Acc: 0.9518
Detailed Bal_Acc: 0.9518 (B: 0.9167, M: 0.9868)
Tumor Acc: 0.6429, LR: 5.00e-04
No improvement for 2/8 epochs

Epoch 5/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.30it/s, loss=0.2895]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  9.77it/s]
Train - Loss: 0.3826, Acc: 0.9327, F1: 0.9326, Bal_Acc: 0.9327
Val - Loss: 0.7655, Acc: 0.9375, F1: 0.9377, Bal_Acc: 0.9320
Detailed Bal_Acc: 0.9320 (B: 0.9167, M: 0.9474)
Tumor Acc: 0.4821, LR: 4.97e-04
No improvement for 3/8 epochs

Epoch 6/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.29it/s, loss=0.2231]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  9.53it/s]
Train - Loss: 0.3701, Acc: 0.9383, F1: 0.9383, Bal_Acc: 0.9383
Val - Loss: 0.6865, Acc: 0.9643, F1: 0.9645, Bal_Acc: 0.9664
Detailed Bal_Acc: 0.9664 (B: 0.9722, M: 0.9605)
Tumor Acc: 0.5536, LR: 4.90e-04
No improvement for 4/8 epochs

Epoch 7/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.43it/s, loss=0.3631]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  8.81it/s]
Train - Loss: 0.3647, Acc: 0.9319, F1: 0.9318, Bal_Acc: 0.9319
Val - Loss: 0.8430, Acc: 0.9107, F1: 0.9113, Bal_Acc: 0.9050
Detailed Bal_Acc: 0.9050 (B: 0.8889, M: 0.9211)
Tumor Acc: 0.5446, LR: 4.77e-04
No improvement for 5/8 epochs

Epoch 8/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.34it/s, loss=0.4389]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  8.90it/s]
Train - Loss: 0.3444, Acc: 0.9487, F1: 0.9487, Bal_Acc: 0.9487
Val - Loss: 0.7352, Acc: 0.9464, F1: 0.9464, Bal_Acc: 0.9386
Detailed Bal_Acc: 0.9386 (B: 0.9167, M: 0.9605)
Tumor Acc: 0.6250, LR: 4.60e-04
No improvement for 6/8 epochs

Epoch 9/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.34it/s, loss=0.3652]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  9.04it/s]
Train - Loss: 0.3314, Acc: 0.9615, F1: 0.9615, Bal_Acc: 0.9615
Val - Loss: 0.6913, Acc: 0.9732, F1: 0.9735, Bal_Acc: 0.9803
Detailed Bal_Acc: 0.9803 (B: 1.0000, M: 0.9605)
Tumor Acc: 0.5804, LR: 4.39e-04
No improvement for 7/8 epochs

Epoch 10/25
--------------------------------------------------
Training: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 78/78 [00:09<00:00,  8.41it/s, loss=0.5002]
Validating: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 7/7 [00:00<00:00,  9.30it/s]
Train - Loss: 0.3517, Acc: 0.9455, F1: 0.9455, Bal_Acc: 0.9455
Val - Loss: 0.7905, Acc: 0.9375, F1: 0.9388, Bal_Acc: 0.9539
Detailed Bal_Acc: 0.9539 (B: 1.0000, M: 0.9079)
Tumor Acc: 0.5536, LR: 4.14e-04
No improvement for 8/8 epochs

⏹️ Early stopping triggered after 10 epochs
Best balanced accuracy: 0.9868

=== DETAILED CLASSIFICATION REPORT ===
              precision    recall  f1-score   support

      benign     0.8372    1.0000    0.9114        36
   malignant     1.0000    0.9079    0.9517        76

    accuracy                         0.9375       112
   macro avg     0.9186    0.9539    0.9316       112
weighted avg     0.9477    0.9375    0.9388       112


=== CONFUSION MATRIX ===
Predicted:  benign  malignant
benign:         36        0
malignant:       7       69

=== KEY INSIGHTS ===
Benign Recall: 1.0000 (36/36)
Malignant Recall: 0.9079 (69/76)

Prediction distribution: benign=43, malignant=69
Analyzing cross-magnification feature importance...

Final Validation Accuracy: 1.0000

Magnification Importance Analysis:
40x contribution: 0.0248 ± 0.0444
100x contribution: 0.0437 ± 0.0462
200x contribution: 0.0188 ± 0.0455
400x contribution: 0.0057 ± 0.0273
/workspace/BC-Attention-Fusion/plotting.py:175: RuntimeWarning: More than 20 figures have been opened. Figures created through the pyplot interface (`matplotlib.pyplot.figure`) are retained until explicitly closed and may consume too much memory. (To control this warning, see the rcParam `figure.max_open_warning`). Consider using `matplotlib.pyplot.close()`.
  plt.figure(figsize=(10, 6))

📊 Cross-Fold Summary Statistics:
 fold_no  multi_mag_patients_count  single_mag_patients_count  train_samples  test_samples
       1                        82                          0           5005          2904
       2                        82                          0           5506          2403
       3                        82                          0           5332          2577
       4                        82                          0           5211          2698
       5                        82                          0           4826          3083

=== Per-Fold Results ===
|        |   accuracy |   precision |   recall |     f1 |
|--------|------------|-------------|----------|--------|
| Fold 1 |     0.9107 |      0.9342 |   0.9342 | 0.9342 |
| Fold 2 |     0.8571 |      1.0000 |   0.7895 | 0.8824 |
| Fold 3 |     0.9286 |      0.9595 |   0.9342 | 0.9467 |
| Fold 4 |     0.8750 |      0.9306 |   0.8816 | 0.9054 |
| Fold 5 |     0.9375 |      1.0000 |   0.9079 | 0.9517 |
Traceback (most recent call last):
  File "/workspace/BC-Attention-Fusion/main.py", line 256, in <module>
    main()
  File "/workspace/BC-Attention-Fusion/main.py", line 210, in main
    plot_training_metrics(all_fold_histories, save_path='figs/training_metrics.png')
  File "/workspace/BC-Attention-Fusion/plotting.py", line 78, in plot_training_metrics
    axs[0].plot(epochs, history_dict['train_loss'][i], linestyle='--', color=colors[i], label=f'Train Fold {i+1}')
  File "/usr/local/lib/python3.11/dist-packages/matplotlib/axes/_axes.py", line 1777, in plot
    lines = [*self._get_lines(self, *args, data=data, **kwargs)]
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/dist-packages/matplotlib/axes/_base.py", line 297, in __call__
    yield from self._plot_args(
               ^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/dist-packages/matplotlib/axes/_base.py", line 494, in _plot_args
    raise ValueError(f"x and y must have same first dimension, but "
ValueError: x and y must have same first dimension, but have shapes (11,) and (12,)